<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>android 自动化测试 &#8211; wi's Tech Blog</title>
<meta name="description" content="notes, articles, or reproduced">
<meta name="keywords" content="android, ui-automator, espresso">



<!-- Open Graph -->
<meta property="og:locale" content="zh_CN">
<meta property="og:type" content="article">
<meta property="og:title" content="android 自动化测试">
<meta property="og:description" content="notes, articles, or reproduced">
<meta property="og:url" content="/dev/android/android-ui-automate-testing/">
<meta property="og:site_name" content="wi's Tech Blog">
<meta property="og:image" content="/images/images/avatar.png">





<link rel="canonical" href="/dev/android/android-ui-automate-testing/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="wi's Tech Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->

<meta http-equiv="cleartype" content="on">

<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="/assets/js/scripts.min.js"></script>

<!-- table of content -->
<script type="text/javascript" src="/assets/js/vendor/toc.js"></script>


<!-- Load Modernizr -->
<script type="text/javascript" src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Mathjax Support -->
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body>

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><i class="fa fa-bars"></i></a></li>
      <li class="header-item-title">
        <a href="/">
          
            <img class="logo" src="/images/avatar.png" alt="wi's Tech Blog">
          
          <a href="/" class="title"> wi's Tech Blog</a>
        </a>
      </li>
      
        
        


        
            
                <li class="header-item "><a href="/favorites">fav</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/categories">Categories</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/tags">Tags</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/">Home</a></li>
            
        
      
      <li class="header-item"><a href="/search"><i class="fa fa-search"></i></a></li>
    </ul>
  </div>



<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="/"><h3>Home</h3></a></li>
      
    
      
        <li><a href="/tags"><h3>Tags</h3></a></li>
      
    
      
        <li><a href="/categories"><h3>Categories</h3></a>
          <ul>
            
              
                <li><a href="/categories/#UML">UML</a></li>
            
              
                <li><a href="/categories/#Windows">Windows</a></li>
            
              
                <li><a href="/categories/#adb">adb</a></li>
            
              
                <li><a href="/categories/#adt">adt</a></li>
            
              
                <li><a href="/categories/#android">android</a></li>
            
              
                <li><a href="/categories/#apache">apache</a></li>
            
              
                <li><a href="/categories/#apple">apple</a></li>
            
              
                <li><a href="/categories/#bat">bat</a></li>
            
              
                <li><a href="/categories/#blog">blog</a></li>
            
              
                <li><a href="/categories/#blog_sample">blog_sample</a></li>
            
              
                <li><a href="/categories/#browser">browser</a></li>
            
              
                <li><a href="/categories/#burpsuite">burpsuite</a></li>
            
              
                <li><a href="/categories/#centos">centos</a></li>
            
              
                <li><a href="/categories/#chrome">chrome</a></li>
            
              
                <li><a href="/categories/#cm">cm</a></li>
            
              
                <li><a href="/categories/#common">common</a></li>
            
              
                <li><a href="/categories/#css">css</a></li>
            
              
                <li><a href="/categories/#cygwin">cygwin</a></li>
            
              
                <li><a href="/categories/#database">database</a></li>
            
              
                <li><a href="/categories/#db">db</a></li>
            
              
                <li><a href="/categories/#dev">dev</a></li>
            
              
                <li><a href="/categories/#device">device</a></li>
            
              
                <li><a href="/categories/#diff">diff</a></li>
            
              
                <li><a href="/categories/#disk">disk</a></li>
            
              
                <li><a href="/categories/#diy">diy</a></li>
            
              
                <li><a href="/categories/#dns">dns</a></li>
            
              
                <li><a href="/categories/#doc">doc</a></li>
            
              
                <li><a href="/categories/#docker">docker</a></li>
            
              
                <li><a href="/categories/#efi">efi</a></li>
            
              
                <li><a href="/categories/#emacs">emacs</a></li>
            
              
                <li><a href="/categories/#email">email</a></li>
            
              
                <li><a href="/categories/#emulator">emulator</a></li>
            
              
                <li><a href="/categories/#english">english</a></li>
            
              
                <li><a href="/categories/#esxi">esxi</a></li>
            
              
                <li><a href="/categories/#excel">excel</a></li>
            
              
                <li><a href="/categories/#exsi">exsi</a></li>
            
              
                <li><a href="/categories/#favorites">favorites</a></li>
            
              
                <li><a href="/categories/#ftp">ftp</a></li>
            
              
                <li><a href="/categories/#game">game</a></li>
            
              
                <li><a href="/categories/#git">git</a></li>
            
              
                <li><a href="/categories/#gitlab">gitlab</a></li>
            
              
                <li><a href="/categories/#go">go</a></li>
            
              
                <li><a href="/categories/#golang">golang</a></li>
            
              
                <li><a href="/categories/#hardware">hardware</a></li>
            
              
                <li><a href="/categories/#ide">ide</a></li>
            
              
                <li><a href="/categories/#internet">internet</a></li>
            
              
                <li><a href="/categories/#java">java</a></li>
            
              
                <li><a href="/categories/#javascript">javascript</a></li>
            
              
                <li><a href="/categories/#jekyll">jekyll</a></li>
            
              
                <li><a href="/categories/#jenkins">jenkins</a></li>
            
              
                <li><a href="/categories/#jmeter">jmeter</a></li>
            
              
                <li><a href="/categories/#kate">kate</a></li>
            
              
                <li><a href="/categories/#kde">kde</a></li>
            
              
                <li><a href="/categories/#ldap">ldap</a></li>
            
              
                <li><a href="/categories/#learn">learn</a></li>
            
              
                <li><a href="/categories/#learning">learning</a></li>
            
              
                <li><a href="/categories/#links">links</a></li>
            
              
                <li><a href="/categories/#linux">linux</a></li>
            
              
                <li><a href="/categories/#living">living</a></li>
            
              
                <li><a href="/categories/#mac">mac</a></li>
            
              
                <li><a href="/categories/#mac-os">mac-os</a></li>
            
              
                <li><a href="/categories/#macos">macos</a></li>
            
              
                <li><a href="/categories/#mail">mail</a></li>
            
              
                <li><a href="/categories/#manjaro">manjaro</a></li>
            
              
                <li><a href="/categories/#markdown">markdown</a></li>
            
              
                <li><a href="/categories/#maven">maven</a></li>
            
              
                <li><a href="/categories/#memcached">memcached</a></li>
            
              
                <li><a href="/categories/#microsoft">microsoft</a></li>
            
              
                <li><a href="/categories/#moco">moco</a></li>
            
              
                <li><a href="/categories/#mysql">mysql</a></li>
            
              
                <li><a href="/categories/#nas">nas</a></li>
            
              
                <li><a href="/categories/#ndk">ndk</a></li>
            
              
                <li><a href="/categories/#netbean">netbean</a></li>
            
              
                <li><a href="/categories/#network">network</a></li>
            
              
                <li><a href="/categories/#netwrok">netwrok</a></li>
            
              
                <li><a href="/categories/#nginx">nginx</a></li>
            
              
                <li><a href="/categories/#nodejs">nodejs</a></li>
            
              
                <li><a href="/categories/#notepad++">notepad++</a></li>
            
              
                <li><a href="/categories/#office">office</a></li>
            
              
                <li><a href="/categories/#open-course">open-course</a></li>
            
              
                <li><a href="/categories/#openkm">openkm</a></li>
            
              
                <li><a href="/categories/#openwrt">openwrt</a></li>
            
              
                <li><a href="/categories/#outlook">outlook</a></li>
            
              
                <li><a href="/categories/#pdf">pdf</a></li>
            
              
                <li><a href="/categories/#perl">perl</a></li>
            
              
                <li><a href="/categories/#phone">phone</a></li>
            
              
                <li><a href="/categories/#php">php</a></li>
            
              
                <li><a href="/categories/#postgresql">postgresql</a></li>
            
              
                <li><a href="/categories/#product">product</a></li>
            
              
                <li><a href="/categories/#python">python</a></li>
            
              
                <li><a href="/categories/#rails">rails</a></li>
            
              
                <li><a href="/categories/#redmine">redmine</a></li>
            
              
                <li><a href="/categories/#regex">regex</a></li>
            
              
                <li><a href="/categories/#router">router</a></li>
            
              
                <li><a href="/categories/#ruby">ruby</a></li>
            
              
                <li><a href="/categories/#search-engine">search-engine</a></li>
            
              
                <li><a href="/categories/#security">security</a></li>
            
              
                <li><a href="/categories/#sed">sed</a></li>
            
              
                <li><a href="/categories/#ssh">ssh</a></li>
            
              
                <li><a href="/categories/#streaming">streaming</a></li>
            
              
                <li><a href="/categories/#study">study</a></li>
            
              
                <li><a href="/categories/#subversion">subversion</a></li>
            
              
                <li><a href="/categories/#tcpdump">tcpdump</a></li>
            
              
                <li><a href="/categories/#tech">tech</a></li>
            
              
                <li><a href="/categories/#testing">testing</a></li>
            
              
                <li><a href="/categories/#testlink">testlink</a></li>
            
              
                <li><a href="/categories/#text">text</a></li>
            
              
                <li><a href="/categories/#tomcat">tomcat</a></li>
            
              
                <li><a href="/categories/#ubuntu">ubuntu</a></li>
            
              
                <li><a href="/categories/#ufw">ufw</a></li>
            
              
                <li><a href="/categories/#vbs">vbs</a></li>
            
              
                <li><a href="/categories/#vim">vim</a></li>
            
              
                <li><a href="/categories/#virtual-box">virtual-box</a></li>
            
              
                <li><a href="/categories/#virtualbox">virtualbox</a></li>
            
              
                <li><a href="/categories/#virtualization">virtualization</a></li>
            
              
                <li><a href="/categories/#vm">vm</a></li>
            
              
                <li><a href="/categories/#vpn">vpn</a></li>
            
              
                <li><a href="/categories/#web">web</a></li>
            
              
                <li><a href="/categories/#windows">windows</a></li>
            
              
                <li><a href="/categories/#xampp">xampp</a></li>
            
              
                <li><a href="/categories/#收藏夹">收藏夹</a></li>
            
              
                <li><a href="/categories/#测试工具">测试工具</a></li>
            
              
                <li><a href="/categories/#玩机">玩机</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="/favorites"><h3>fav</h3></a></li>
      
    
  </ul>
</nav>




<div id="post" >
<div id="main" role="main" >
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">android 自动化测试</h1>
      
        <h3><span class="entry-date date published updated"><time datetime="2017-12-25T00:00:00+08:00">December 25, 2017</time></span></h3>
      
      
      
      
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 60);
  return false
})

$(".toc-button").on('click', function(){
  $(".toc").toggle();
});


$(window).click(function(evt){
  if( !evt.target.matches('.toc') 
      && !evt.target.matches('.toc>ul') 
      && !evt.target.matches('.toc-button') ) {
    $('.toc').each(function(){
      if( $(this).is(":visible") ) {
        $(this).hide();
      }
    });
  }
});

});
</script>

<div class="float-toc">
    <i class="toc-button fa fa-list-ol" aria-hidden="true"></i>
  <div id="toc"></div>
</div>

      
      
      <ul>
  <li><a href="https://developer.android.com/topic/libraries/testing-support-library/index.html">Android Develop - Testing Support Library</a></li>
  <li><a href="https://developer.android.com/training/testing/ui-automator.html">Android Develop - UI Automator</a></li>
  <li><a href="https://developer.android.com/training/testing/espresso/index.html">Android Develop - Espresso</a></li>
  <li><a href="https://developer.android.com/training/testing/ui-testing/uiautomator-testing.html">Android Develop - Testing UI for Multiple Apps</a></li>
  <li><a href="http://www.vogella.com/tutorials/AndroidTestingEspresso/article.html">vogella.com - Android user interface testing with Espresso - Tutorial</a></li>
  <li>《腾讯Android自动化测试实战》</li>
  <li><a href=""></a></li>
</ul>

<h2 id="自动化测试介绍">自动化测试介绍</h2>

<h3 id="android-自动化测试框架">Android 自动化测试框架</h3>

<ul>
  <li>Monkey</li>
  <li>MonkeyRunner</li>
  <li>Instrumentation</li>
  <li>MonkeyRunner</li>
  <li>UIAutomator 【跨应用】</li>
  <li>Robotium  <strong>最后一次更新于2016年</strong><br />
  基于 Instrumentation。<br />
  <a href="https://github.com/RobotiumTech/robotium">https://github.com/RobotiumTech/robotium</a></li>
  <li>Robolectric<br />
  主要支持单元测试。</li>
  <li>Selendroid</li>
  <li>Espresso</li>
  <li>Calabash</li>
  <li>Appium<br />
  使用 Selenium 的 WebDriver JSON 协议</li>
  <li>Macaca（淘宝）
    <ul>
      <li><a href="https://macacajs.com/zh/">https://macacajs.com/zh/</a></li>
      <li>支持在移动端和PC端的Native, Hybrid, 移动端Web应用</li>
    </ul>
  </li>
  <li>Airtest（网易）
    <ul>
      <li><a href="https://airtest.netease.com">https://airtest.netease.com</a></li>
    </ul>
  </li>
  <li></li>
</ul>

<p><img src="android-auto-test-framework.png" alt="" /></p>

<p><img src="android-auto-test-framework-02.png" alt="" /></p>

<h3 id="自动化测试的基础知识">自动化测试的基础知识</h3>

<p><img src="android-auto-test-foundation.png" alt="" /></p>

<h3 id="自动化测试基本步骤">自动化测试基本步骤</h3>

<p><img src="android-auto-test-process.png" alt="" /></p>

<h3 id="自动化测试的使用场景">自动化测试的使用场景</h3>

<p><img src="android-auto-test-scenario.png" alt="" /></p>

<h2 id="monkey">Monkey</h2>

<ul>
  <li>参考：
    <ul>
      <li><a href="https://developer.android.com/studio/test/monkey">Android 官方手册 - UI/Application Exerciser Monkey</a></li>
      <li><a href=""></a></li>
    </ul>
  </li>
</ul>

<p>启动脚本在 <code class="highlighter-rouge">/system/bin</code> 目录的 Monkey 文件。</p>

<p>jar包在 <code class="highlighter-rouge">/system/framework/</code> 目录的 <code class="highlighter-rouge">Monkey.jar</code></p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>adb shell monkey [options] &lt;event-count&gt;
</pre></td></tr></tbody></table>
</div>
</div>

<p>常规的monkey测试是，随机事件流。但也可以自定义脚本来执行指定事件流。</p>

<h3 id="monkey-自定义脚本编写">monkey 自定义脚本编写</h3>

<p>Monkey 脚本只能通过坐标的方式来定位点击、移动事件，需要提前获取坐标。</p>

<p><strong>获取坐标信息的方法</strong> ： 开发人员选项 》显示指针位置</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>monkey -f some-test.script
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li><code class="highlighter-rouge">some-test.script</code> :</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><pre># 进入应用宝，输入 yyb 进行搜索的例子

# 启动测试

type = user
count = 49
speed = 1.0
start data &gt;&gt;

# 启动应用宝
LaunchActivity(com.tencent.qqdownloader, com.tencent.assistant.activity.SplashActivity)
UserWait(2000)

# 点击搜索
Tap(463,150,1000)
UserWait(2000)

# 输入字母 yyb
DispatchString(yyb)
UserWait(2000)

# 点击搜索
Tap(960,150,1000)
UserWait(2000)

# 点击返回键返回首页
DispatchPress(KEYCODE_BACK)
</pre></td></tr></tbody></table>
</div>
</div>

<p>将执行文件push到手机后，执行</p>
<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>adb push some-test.script /sdcard/
# 执行10次
adb shell monkey -f /sdcard/some-test.script -v 10
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="monkey-script-的常见api">Monkey Script 的常见API</h3>

<p><img src="monkey-script-apis.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre>DispatchPointer(long downTime,  long eventTime, int action,float x, float y, float pressure, float size, int metaState,float xPrecision, float yPrecision, int device, int edgeFlags) 
DispatchTrackball same as DispatchPointer 
DispatchKey(long downTime, long eventTime, int action, int code,int repeat, int metaState, int device, int scancode) 
DispatchFlip(boolean keyboardOpen) 
DispatchPress(int keyCode) 
Tap(int x,int y) 
LaunchActivity(String pkg_name, String cl_name) 
UserWait(long sleeptime) 
LongPress(long sleeptime)
DispatchPointer:  This is used to perform task such as Dragging, tapping, clicking, even entering alphabet in target.
DispatchTrackball: same as DispatchPointer
Tap:  This is used tap Android Device.ex any icon, application etc. in given coordinate.
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="uiautomator">UiAutomator</h2>

<ul>
  <li><a href="https://stackoverflow.com/a/35308116">uiobject 方式遍历list items</a></li>
</ul>

<h3 id="一般测试流程">一般测试流程</h3>

<ol>
  <li>分析UI元素，获取元素属性</li>
  <li>开发测试代码，模拟用户操作。</li>
  <li>编译测试代码成jar，push到手机。</li>
  <li>在手机上运行测试，搜集测试结果。</li>
</ol>

<h3 id="获取元素信息的方法">获取元素信息的方法</h3>

<ol>
  <li>使用uiautomatorviewer工具</li>
</ol>

<p><code class="highlighter-rouge">./sdk/tools/bin/uiautomatorviewer</code></p>

<h3 id="开发">开发</h3>

<h4 id="创建-project">创建 Project</h4>

<p>创建Java Project（而不是Android Project），加入依赖： <code class="highlighter-rouge">android.jar</code>、<code class="highlighter-rouge">uiautomator.jar</code>， 2个jar都在 <code class="highlighter-rouge">./sdk/platforms/android-xx</code> 目录。<br />
android-19 以上的新增 <code class="highlighter-rouge">UiSelector.resourceId</code> 系列方法，能通过resource id 定位元素。</p>

<h4 id="开发用例">开发用例</h4>

<ul>
  <li>每个用例都继承自 <code class="highlighter-rouge">UiAutomatorTestCase</code></li>
  <li><code class="highlighter-rouge">setUp()</code> 先于每个用例执行。进行用例执行的准备。</li>
  <li><code class="highlighter-rouge">tearDown()</code> 后于每个用例执行。搜集用例结果，恢复环境。</li>
  <li>一个 Class 可以包含多个用例 testXXX()，但不建议耦合、存在顺序依赖关系。</li>
  <li></li>
</ul>

<ol>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
</ol>

<h2 id="espresso">Espresso</h2>

<p>Espresso test 示例代码:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">greeterSaysHello</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">name_field</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">typeText</span><span class="o">(</span><span class="s">"Steve"</span><span class="o">));</span>
    <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">greet_button</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">click</span><span class="o">());</span>
    <span class="n">onView</span><span class="o">(</span><span class="n">withText</span><span class="o">(</span><span class="s">"Hello Steve!"</span><span class="o">)).</span><span class="na">check</span><span class="o">(</span><span class="n">matches</span><span class="o">(</span><span class="n">isDisplayed</span><span class="o">()));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>The core API is small, predictable, and easy to learn and yet remains open for customization. Espresso tests state expectations, interactions, and assertions clearly without the distraction of boilerplate content, custom infrastructure, or messy implementation details getting in the way.</p>

<p>Espresso tests run optimally fast! It lets you leave your waits, syncs, sleeps, and polls behind while it manipulates and asserts on the application UI when it is at rest.</p>

<h3 id="target-audience">Target Audience</h3>

<p>Espresso is targeted at developers, who believe that automated testing is an integral part of the development lifecycle. While it can be used for black-box testing, Espresso’s full power is unlocked by those who are familiar with the codebase under test.</p>

<h3 id="packages">Packages</h3>

<ul>
  <li>espresso-core - Contains core and basic View matchers, actions, and assertions. See <a href="espresso-basic">Basics</a> and <a href="https://developer.android.com/training/testing/espresso/recipes.html">Recipes</a>.</li>
  <li><a href="https://developer.android.com/training/testing/espresso/web.html">espresso-web</a> - Contains resources for WebView support.</li>
  <li><a href="https://developer.android.com/training/testing/espresso/idling-resource.html">espresso-idling-resource</a> - Espresso’s mechanism for synchronization with background jobs.</li>
  <li>espresso-contrib - External contributions that contain DatePicker, RecyclerView and Drawer actions, accessibility checks, and CountingIdlingResource.</li>
  <li><a href="https://developer.android.com/training/testing/espresso/intents.html">espresso-intents</a> - Extension to validate and stub intents for hermetic testing.<br />
You can learn more about the latest versions by reading the release notes.</li>
</ul>

<h3 id="如何在项目中使用-espresso">如何在项目中使用 Espresso</h3>

<h4 id="配置gradle">配置Gradle</h4>

<p>add the following dependency to the Gradle build file of your app.</p>

<div class="language-gradle highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre></td><td class="code"><pre><span class="k">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="nf">fileTree</span><span class="o">(</span><span class="nl">dir:</span> <span class="s1">'libs'</span><span class="o">,</span> <span class="nl">include:</span> <span class="o">[</span><span class="s1">'*.jar'</span><span class="o">])</span>

    <span class="n">testCompile</span> <span class="s1">'junit:junit:4.12'</span>

    <span class="c1">// Android runner and rules support</span>
    <span class="n">androidTestCompile</span> <span class="s1">'com.android.support.test:runner:0.5'</span>
    <span class="n">androidTestCompile</span> <span class="s1">'com.android.support.test:rules:0.5'</span>

    <span class="c1">// Espresso support</span>
    <span class="n">androidTestCompile</span><span class="o">(</span><span class="s1">'com.android.support.test.espresso:espresso-core:2.2.2'</span><span class="o">,</span> <span class="o">{</span>
        <span class="n">exclude</span> <span class="nl">group:</span> <span class="s1">'com.android.support'</span><span class="o">,</span> <span class="nl">module:</span> <span class="s1">'support-annotations'</span>
    <span class="o">})</span>

    <span class="c1">// add this for intent mocking support</span>
    <span class="n">androidTestCompile</span> <span class="s1">'com.android.support.test.espresso:espresso-intents:2.2.2'</span>

    <span class="c1">// add this for webview testing support</span>
    <span class="n">androidTestCompile</span> <span class="s1">'com.android.support.test.espresso:espresso-web:2.2.2'</span>

<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Ensure that the <code class="highlighter-rouge">android.support.test.runner.AndroidJUnitRunner</code> is specified as value for the <code class="highlighter-rouge">testInstrumentationRunner</code> parameter in the build file of your app. Via the packagingOptions you may have to exclude LICENSE.txt, depending on the libraries you are using.</p>

<div class="language-gradle highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre><span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'com.android.application'</span>

<span class="n">android</span> <span class="o">{</span>
    <span class="n">compileSdkVersion</span> <span class="mi">22</span>
    <span class="n">buildToolsVersion</span> <span class="s1">'22.0.1'</span>
    <span class="n">defaultConfig</span> <span class="o">{</span>
        <span class="n">applicationId</span> <span class="s2">"com.example.android.testing.espresso.BasicSample"</span>
        <span class="n">minSdkVersion</span> <span class="mi">10</span>
        <span class="n">targetSdkVersion</span> <span class="mi">22</span>
        <span class="n">versionCode</span> <span class="mi">1</span>
        <span class="n">versionName</span> <span class="s2">"1.0"</span>

        <span class="n">testInstrumentationRunner</span> <span class="s2">"android.support.test.runner.AndroidJUnitRunner"</span>
    <span class="o">}</span>
    <span class="n">packagingOptions</span> <span class="o">{</span>
        <span class="n">exclude</span> <span class="s1">'LICENSE.txt'</span>
    <span class="o">}</span>
    <span class="n">lintOptions</span> <span class="o">{</span>
        <span class="n">abortOnError</span> <span class="kc">false</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">dependencies</span> <span class="o">{</span>
    <span class="c1">// as before.......</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="device-settings">Device settings</h4>

<p><img src="turn-off-animation.png" alt="" style="width:260px" /> <img src="turn-off-animation2.png" alt="" style="width:260px" /></p>

<h3 id="exercise-a-first-espresso-test">Exercise: A first Espresso test</h3>

<h4 id="create-project-under-test">Create project under test</h4>

<p>Create a new Android project called Espresso First with the package name com.vogella.android.espressofirst. Use the Blank Template as basis for this project.</p>

<p>Change the generated activity_main.xml layout file to the following.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class="code"><pre><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">xmlns:tools=</span><span class="s">"http://schemas.android.com/tools"</span>
    <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
    <span class="na">android:layout_height=</span><span class="s">"match_parent"</span>
    <span class="nt">&gt;</span>

    <span class="nt">&lt;EditText</span>
        <span class="na">android:id=</span><span class="s">"@+id/inputField"</span>
        <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
        <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;Button</span>
        <span class="na">android:id=</span><span class="s">"@+id/changeText"</span>
        <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
        <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
        <span class="na">android:text=</span><span class="s">"New Button"</span> <span class="na">android:onClick=</span><span class="s">"onClick"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;Button</span>
        <span class="na">android:id=</span><span class="s">"@+id/switchActivity"</span>
        <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
        <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
        <span class="na">android:text=</span><span class="s">"Change Text"</span> <span class="na">android:onClick=</span><span class="s">"onClick"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Create a new file called activity_second.xml.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">android:orientation=</span><span class="s">"vertical"</span> <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
    <span class="na">android:layout_height=</span><span class="s">"match_parent"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;TextView</span>
        <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
        <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
        <span class="na">android:textAppearance=</span><span class="s">"?android:attr/textAppearanceLarge"</span>
        <span class="na">android:text=</span><span class="s">"Large Text"</span>
        <span class="na">android:id=</span><span class="s">"@+id/resultView"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Create a new activity with the following code.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">vogella</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">espressofirst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecondActivity</span> <span class="kd">extends</span> <span class="n">Activity</span><span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_second</span><span class="o">);</span>
        <span class="n">TextView</span> <span class="n">viewById</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">resultView</span><span class="o">);</span>
        <span class="n">Bundle</span> <span class="n">inputData</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getExtras</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">input</span> <span class="o">=</span> <span class="n">inputData</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"input"</span><span class="o">);</span>
        <span class="n">viewById</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Also adjust your MainActivity class.</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></td><td class="code"><pre>package com.vogella.android.espressofirst;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.EditText;

public class MainActivity extends Activity {

    EditText editText;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        editText = (EditText) findViewById(R.id.inputField);
    }


    public void onClick(View view) {
        switch (view.getId()) {
            case R.id.changeText:
                editText.setText("Lalala");
                break;
            case R.id.switchActivity:
                Intent intent = new Intent(this, SecondActivity.class);
                intent.putExtra("input", editText.getText().toString());
                startActivity(intent);
                break;
        }

    }
}
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="create-your-espresso-test">Create your Espresso test</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></td><td class="code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">vogella</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">espressofirst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.support.test.rule.ActivityTestRule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.support.test.runner.AndroidJUnit4</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Rule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">.</span><span class="na">Espresso</span><span class="o">.</span><span class="na">onView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">.</span><span class="na">action</span><span class="o">.</span><span class="na">ViewActions</span><span class="o">.</span><span class="na">click</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">.</span><span class="na">action</span><span class="o">.</span><span class="na">ViewActions</span><span class="o">.</span><span class="na">closeSoftKeyboard</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">.</span><span class="na">action</span><span class="o">.</span><span class="na">ViewActions</span><span class="o">.</span><span class="na">typeText</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">.</span><span class="na">assertion</span><span class="o">.</span><span class="na">ViewAssertions</span><span class="o">.</span><span class="na">matches</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">.</span><span class="na">matcher</span><span class="o">.</span><span class="na">ViewMatchers</span><span class="o">.</span><span class="na">withId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">android</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">espresso</span><span class="o">.</span><span class="na">matcher</span><span class="o">.</span><span class="na">ViewMatchers</span><span class="o">.</span><span class="na">withText</span><span class="o">;</span>


<span class="nd">@RunWith</span><span class="o">(</span><span class="n">AndroidJUnit4</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivityEspressoTest</span> <span class="o">{</span>


    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="n">ActivityTestRule</span><span class="o">&lt;</span><span class="n">MainActivity</span><span class="o">&gt;</span> <span class="n">mActivityRule</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">ActivityTestRule</span><span class="o">&lt;&gt;(</span><span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">ensureTextChangesWork</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Type text and then press the button.</span>
        <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">inputField</span><span class="o">))</span>
                <span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">typeText</span><span class="o">(</span><span class="s">"HELLO"</span><span class="o">),</span> <span class="n">closeSoftKeyboard</span><span class="o">());</span>
        <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">changeText</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">click</span><span class="o">());</span>

        <span class="c1">// Check that the text was changed.</span>
        <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">inputField</span><span class="o">)).</span><span class="na">check</span><span class="o">(</span><span class="n">matches</span><span class="o">(</span><span class="n">withText</span><span class="o">(</span><span class="s">"Lalala"</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changeText_newActivity</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Type text and then press the button.</span>
        <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">inputField</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">typeText</span><span class="o">(</span><span class="s">"NewText"</span><span class="o">),</span>
                <span class="n">closeSoftKeyboard</span><span class="o">());</span>
        <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">switchActivity</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">click</span><span class="o">());</span>

        <span class="c1">// This view is in a different Activity, no need to tell Espresso.</span>
        <span class="n">onView</span><span class="o">(</span><span class="n">withId</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">resultView</span><span class="o">)).</span><span class="na">check</span><span class="o">(</span><span class="n">matches</span><span class="o">(</span><span class="n">withText</span><span class="o">(</span><span class="s">"NewText"</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="在android-sutdio里面右击-mainactivityespressotest选择-run">在Android Sutdio里面，右击 MainActivityEspressoTest，选择 Run</h4>

<h3 id="利用-adb-运行-espresso">利用 adb 运行 espresso</h3>

<p>参考： <a href="https://developer.android.com/studio/test/command-line.html">https://developer.android.com/studio/test/command-line.html</a></p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>adb shell am instrument -w &lt;test_package_name&gt;/&lt;runner_class&gt;

adb shell am instrument -w com.your-name.espressofirst.test/android.support.test.runner.AndroidJUnitRunner
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="espresso-cheatsheet">espresso-cheatsheet</h3>

<p><img src="espresso-cheatsheet.png" alt="" /></p>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags#android" title="Pages tagged android" class="tag"><span class="term">android</span></a><a href="/tags#ui-automator" title="Pages tagged ui-automator" class="tag"><span class="term">ui-automator</span></a><a href="/tags#espresso" title="Pages tagged espresso" class="tag"><span class="term">espresso</span></a></span>
        
        
      </footer>
    </div><!-- /.entry-content -->
    
    
    
  </article>
</div><!-- /#main -->
</div><!-- post container -->














<script type="text/javascript">
  // embeded-iframe
  $(window).load(function(){
    $('.embeded-iframe').each(function(){
      $(this).height($(this).contents().find('html').height());
    });
  });
</script>





<div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2023 wi. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://github.com/aron-bordin/neo-hpstr-jekyll-theme" rel="nofollow">Neo-HPSTR Theme</a>.</span>

<script src="/assets/js/main.js?20230725301728281823445"></script>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
