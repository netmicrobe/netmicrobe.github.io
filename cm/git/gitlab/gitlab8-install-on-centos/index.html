<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Gitlab 8 在 CentOS 安装 &#8211; wi's Tech Blog</title>
<meta name="description" content="notes, articles, or reproduced">
<meta name="keywords" content="cm, git, gitlab">



<!-- Open Graph -->
<meta property="og:locale" content="zh_CN">
<meta property="og:type" content="article">
<meta property="og:title" content="Gitlab 8 在 CentOS 安装">
<meta property="og:description" content="notes, articles, or reproduced">
<meta property="og:url" content="/cm/git/gitlab/gitlab8-install-on-centos/">
<meta property="og:site_name" content="wi's Tech Blog">
<meta property="og:image" content="/images/images/avatar.png">





<link rel="canonical" href="/cm/git/gitlab/gitlab8-install-on-centos/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="wi's Tech Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->

<meta http-equiv="cleartype" content="on">

<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="/assets/js/scripts.min.js"></script>

<!-- table of content -->
<script type="text/javascript" src="/assets/js/vendor/toc.js"></script>


<!-- Load Modernizr -->
<script type="text/javascript" src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Mathjax Support -->
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body>

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><i class="fa fa-bars"></i></a></li>
      <li class="header-item-title">
        <a href="/">
          
            <img class="logo" src="/images/avatar.png" alt="wi's Tech Blog">
          
          <a href="/" class="title"> wi's Tech Blog</a>
        </a>
      </li>
      
        
        


        
            
                <li class="header-item "><a href="/favorites">fav</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/categories">Categories</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/tags">Tags</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/">Home</a></li>
            
        
      
      <li class="header-item"><a href="/search"><i class="fa fa-search"></i></a></li>
    </ul>
  </div>



<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="/"><h3>Home</h3></a></li>
      
    
      
        <li><a href="/tags"><h3>Tags</h3></a></li>
      
    
      
        <li><a href="/categories"><h3>Categories</h3></a>
          <ul>
            
              
                <li><a href="/categories/#UML">UML</a></li>
            
              
                <li><a href="/categories/#Windows">Windows</a></li>
            
              
                <li><a href="/categories/#adb">adb</a></li>
            
              
                <li><a href="/categories/#adt">adt</a></li>
            
              
                <li><a href="/categories/#android">android</a></li>
            
              
                <li><a href="/categories/#apache">apache</a></li>
            
              
                <li><a href="/categories/#apple">apple</a></li>
            
              
                <li><a href="/categories/#bat">bat</a></li>
            
              
                <li><a href="/categories/#blog">blog</a></li>
            
              
                <li><a href="/categories/#blog_sample">blog_sample</a></li>
            
              
                <li><a href="/categories/#browser">browser</a></li>
            
              
                <li><a href="/categories/#burpsuite">burpsuite</a></li>
            
              
                <li><a href="/categories/#centos">centos</a></li>
            
              
                <li><a href="/categories/#chrome">chrome</a></li>
            
              
                <li><a href="/categories/#cm">cm</a></li>
            
              
                <li><a href="/categories/#common">common</a></li>
            
              
                <li><a href="/categories/#css">css</a></li>
            
              
                <li><a href="/categories/#cygwin">cygwin</a></li>
            
              
                <li><a href="/categories/#database">database</a></li>
            
              
                <li><a href="/categories/#db">db</a></li>
            
              
                <li><a href="/categories/#dev">dev</a></li>
            
              
                <li><a href="/categories/#device">device</a></li>
            
              
                <li><a href="/categories/#diff">diff</a></li>
            
              
                <li><a href="/categories/#disk">disk</a></li>
            
              
                <li><a href="/categories/#diy">diy</a></li>
            
              
                <li><a href="/categories/#dns">dns</a></li>
            
              
                <li><a href="/categories/#doc">doc</a></li>
            
              
                <li><a href="/categories/#docker">docker</a></li>
            
              
                <li><a href="/categories/#efi">efi</a></li>
            
              
                <li><a href="/categories/#emacs">emacs</a></li>
            
              
                <li><a href="/categories/#email">email</a></li>
            
              
                <li><a href="/categories/#emulator">emulator</a></li>
            
              
                <li><a href="/categories/#english">english</a></li>
            
              
                <li><a href="/categories/#esxi">esxi</a></li>
            
              
                <li><a href="/categories/#excel">excel</a></li>
            
              
                <li><a href="/categories/#exsi">exsi</a></li>
            
              
                <li><a href="/categories/#favorites">favorites</a></li>
            
              
                <li><a href="/categories/#ftp">ftp</a></li>
            
              
                <li><a href="/categories/#game">game</a></li>
            
              
                <li><a href="/categories/#git">git</a></li>
            
              
                <li><a href="/categories/#gitlab">gitlab</a></li>
            
              
                <li><a href="/categories/#go">go</a></li>
            
              
                <li><a href="/categories/#golang">golang</a></li>
            
              
                <li><a href="/categories/#hardware">hardware</a></li>
            
              
                <li><a href="/categories/#ide">ide</a></li>
            
              
                <li><a href="/categories/#internet">internet</a></li>
            
              
                <li><a href="/categories/#java">java</a></li>
            
              
                <li><a href="/categories/#javascript">javascript</a></li>
            
              
                <li><a href="/categories/#jekyll">jekyll</a></li>
            
              
                <li><a href="/categories/#jenkins">jenkins</a></li>
            
              
                <li><a href="/categories/#jmeter">jmeter</a></li>
            
              
                <li><a href="/categories/#kate">kate</a></li>
            
              
                <li><a href="/categories/#kde">kde</a></li>
            
              
                <li><a href="/categories/#ldap">ldap</a></li>
            
              
                <li><a href="/categories/#learn">learn</a></li>
            
              
                <li><a href="/categories/#learning">learning</a></li>
            
              
                <li><a href="/categories/#links">links</a></li>
            
              
                <li><a href="/categories/#linux">linux</a></li>
            
              
                <li><a href="/categories/#living">living</a></li>
            
              
                <li><a href="/categories/#mac">mac</a></li>
            
              
                <li><a href="/categories/#mac-os">mac-os</a></li>
            
              
                <li><a href="/categories/#macos">macos</a></li>
            
              
                <li><a href="/categories/#mail">mail</a></li>
            
              
                <li><a href="/categories/#manjaro">manjaro</a></li>
            
              
                <li><a href="/categories/#markdown">markdown</a></li>
            
              
                <li><a href="/categories/#maven">maven</a></li>
            
              
                <li><a href="/categories/#memcached">memcached</a></li>
            
              
                <li><a href="/categories/#microsoft">microsoft</a></li>
            
              
                <li><a href="/categories/#moco">moco</a></li>
            
              
                <li><a href="/categories/#mysql">mysql</a></li>
            
              
                <li><a href="/categories/#nas">nas</a></li>
            
              
                <li><a href="/categories/#ndk">ndk</a></li>
            
              
                <li><a href="/categories/#netbean">netbean</a></li>
            
              
                <li><a href="/categories/#network">network</a></li>
            
              
                <li><a href="/categories/#netwrok">netwrok</a></li>
            
              
                <li><a href="/categories/#nginx">nginx</a></li>
            
              
                <li><a href="/categories/#nodejs">nodejs</a></li>
            
              
                <li><a href="/categories/#notepad++">notepad++</a></li>
            
              
                <li><a href="/categories/#office">office</a></li>
            
              
                <li><a href="/categories/#open-course">open-course</a></li>
            
              
                <li><a href="/categories/#openkm">openkm</a></li>
            
              
                <li><a href="/categories/#openwrt">openwrt</a></li>
            
              
                <li><a href="/categories/#outlook">outlook</a></li>
            
              
                <li><a href="/categories/#pdf">pdf</a></li>
            
              
                <li><a href="/categories/#perl">perl</a></li>
            
              
                <li><a href="/categories/#phone">phone</a></li>
            
              
                <li><a href="/categories/#php">php</a></li>
            
              
                <li><a href="/categories/#postgresql">postgresql</a></li>
            
              
                <li><a href="/categories/#product">product</a></li>
            
              
                <li><a href="/categories/#python">python</a></li>
            
              
                <li><a href="/categories/#rails">rails</a></li>
            
              
                <li><a href="/categories/#redmine">redmine</a></li>
            
              
                <li><a href="/categories/#regex">regex</a></li>
            
              
                <li><a href="/categories/#router">router</a></li>
            
              
                <li><a href="/categories/#ruby">ruby</a></li>
            
              
                <li><a href="/categories/#search-engine">search-engine</a></li>
            
              
                <li><a href="/categories/#security">security</a></li>
            
              
                <li><a href="/categories/#sed">sed</a></li>
            
              
                <li><a href="/categories/#ssh">ssh</a></li>
            
              
                <li><a href="/categories/#streaming">streaming</a></li>
            
              
                <li><a href="/categories/#study">study</a></li>
            
              
                <li><a href="/categories/#subversion">subversion</a></li>
            
              
                <li><a href="/categories/#tcpdump">tcpdump</a></li>
            
              
                <li><a href="/categories/#tech">tech</a></li>
            
              
                <li><a href="/categories/#testing">testing</a></li>
            
              
                <li><a href="/categories/#testlink">testlink</a></li>
            
              
                <li><a href="/categories/#text">text</a></li>
            
              
                <li><a href="/categories/#tomcat">tomcat</a></li>
            
              
                <li><a href="/categories/#ubuntu">ubuntu</a></li>
            
              
                <li><a href="/categories/#ufw">ufw</a></li>
            
              
                <li><a href="/categories/#vbs">vbs</a></li>
            
              
                <li><a href="/categories/#vim">vim</a></li>
            
              
                <li><a href="/categories/#virtual-box">virtual-box</a></li>
            
              
                <li><a href="/categories/#virtualbox">virtualbox</a></li>
            
              
                <li><a href="/categories/#virtualization">virtualization</a></li>
            
              
                <li><a href="/categories/#vm">vm</a></li>
            
              
                <li><a href="/categories/#vpn">vpn</a></li>
            
              
                <li><a href="/categories/#web">web</a></li>
            
              
                <li><a href="/categories/#windows">windows</a></li>
            
              
                <li><a href="/categories/#xampp">xampp</a></li>
            
              
                <li><a href="/categories/#收藏夹">收藏夹</a></li>
            
              
                <li><a href="/categories/#测试工具">测试工具</a></li>
            
              
                <li><a href="/categories/#玩机">玩机</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="/favorites"><h3>fav</h3></a></li>
      
    
  </ul>
</nav>




<div id="post" >
<div id="main" role="main" >
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">Gitlab 8 在 CentOS 安装</h1>
      
        <h3><span class="entry-date date published updated"><time datetime="2016-11-17T00:00:00+08:00">November 17, 2016</time></span></h3>
      
      
      
      
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 60);
  return false
})

$(".toc-button").on('click', function(){
  $(".toc").toggle();
});


$(window).click(function(evt){
  if( !evt.target.matches('.toc') 
      && !evt.target.matches('.toc>ul') 
      && !evt.target.matches('.toc-button') ) {
    $('.toc').each(function(){
      if( $(this).is(":visible") ) {
        $(this).hide();
      }
    });
  }
});

});
</script>

<div class="float-toc">
    <i class="toc-button fa fa-list-ol" aria-hidden="true"></i>
  <div id="toc"></div>
</div>

      
      
      <ul>
  <li>参考
    <ul>
      <li><a href="http://www.open-open.com/lib/view/open1399684894447.html">centos 6.5安装GitLab全过程和问题记录</a></li>
      <li>gitlab recipes - install
        <ul>
          <li><a href="https://gitlab.com/gitlab-org/gitlab-recipes/tree/master/install/centos">gitlab-recipes install on centos</a></li>
          <li><a href="https://github.com/gitlabhq/gitlab-recipes/tree/master/install/centos">gitlab-recipes install on centos - github</a></li>
          <li><a href="https://docs.gitlab.com/ce/install/installation.html">Installation from source</a></li>
        </ul>
      </li>
      <li><a href="https://docs.gitlab.com/ce/README.html">GitLab Community Edition Official Documents</a></li>
      <li><a href="https://docs.gitlab.com/ce/workflow/README.html">GitLab Community Edition - Workflow</a></li>
    </ul>
  </li>
  <li>注意
    <ul>
      <li>无特别说明，文档中的命令都以 root 执行</li>
    </ul>
  </li>
</ul>

<h2 id="安装-gitlab">安装 Gitlab</h2>

<h3 id="操作系统-centos-68">操作系统 CentOS 6.8</h3>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>root@localhost: ~ # rpm --query centos-release
centos-release-6-8.el6.centos.12.3.i686
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="配置第三方-yum-库">配置第三方 yum 库</h4>

<h5 id="add-epel-repository">Add EPEL repository</h5>

<ul>
  <li>
    <p>Download the GPG key</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6 https://getfedora.org/static/0608B895.txt
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>检查是否配置成功：</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>rpm -qa gpg*
gpg-pubkey-0608b895-4bd22942
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>安装 epel-release-6-8.noarch package, which will enable EPEL repository on your system:</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h5 id="add-remis-rpm-repository">Add Remi’s RPM repository</h5>

<ul>
  <li>
    <p>Download the GPG key</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>wget -O /etc/pki/rpm-gpg/RPM-GPG-KEY-remi http://rpms.famillecollet.com/RPM-GPG-KEY-remi
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-remi
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>检查是否配置成功：</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>rpm -qa gpg*
gpg-pubkey-00f97f56-467e318a
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>安装 remi-release-6 package, which will enable remi-safe repository on your system:</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h5 id="检查-yum库是否配置成功">检查 yum库是否配置成功</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre>yum repolist

repo id        repo name                                                       status
base           CentOS-6 - Base                                                  6696
epel           Extra Packages for Enterprise Linux 6 - x86_64                  12125
extras         CentOS-6 - Extras                                                  61
remi-safe      Safe Remi's RPM repository for Enterprise Linux 6 - x86_64        827
updates        CentOS-6 - Updates                                                137
repolist: 19846
</pre></td></tr></tbody></table>
</div>
</div>

<p>没成功，手动enable</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>yum install yum-utils
yum-config-manager --enable epel --enable remi-safe
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="安装-yum-软件包">安装 yum 软件包</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre>yum -y update
yum -y groupinstall <span class="s1">'Development Tools'</span>
yum -y install readline readline-devel ncurses-devel gdbm-devel glibc-devel tcl-devel openssl-devel curl-devel expat-devel db4-devel byacc sqlite-devel libyaml libyaml-devel libffi libffi-devel libxml2 libxml2-devel libxslt libxslt-devel libicu libicu-devel system-config-firewall-tui redis sudo wget crontabs logwatch logrotate perl-Time-HiRes git cmake libcom_err-devel.i686 libcom_err-devel.x86_64 nodejs

<span class="c"># For reStructuredText markup language support, install required package:</span>
yum -y install python-docutils
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>
    <p>注意<br />
如果有些包（eg. gdbm-devel, libffi-devel and libicu-devel）安装不了，尝试执行：</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>yum-config-manager --enable rhel-6-server-optional-rpms
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h4 id="安装-mail-服务器">安装 mail 服务器</h4>

<p>推荐 postfix</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>yum -y install postfix
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="配置缺省的-editor">配置缺省的 Editor</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="c"># Install vim and set as default editor</span>
yum -y install vim-enhanced
ln -s /usr/bin/vim /usr/bin/editor
</pre></td></tr></tbody></table>
</div>
</div>

<p>取消链接</p>

<p>rm -i /usr/bin/editor</p>

<h3 id="从-源码-安装-git274-or-higher">从 源码 安装 Git(2.7.4 or higher)</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre>yum install zlib-devel perl-CPAN gettext curl-devel expat-devel gettext-devel openssl-devel
mkdir /tmp/git <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /tmp/git
curl --progress https://www.kernel.org/pub/software/scm/git/git-2.9.0.tar.gz | tar xz
<span class="nb">cd </span>git-2.9.0
./configure
make
make <span class="nv">prefix</span><span class="o">=</span>/usr/local install
</pre></td></tr></tbody></table>
</div>
</div>

<p>将 Git 的执行目录 加入到 $PATH</p>

<p>修改 config/gitlab.yml ，将 git bin_path 改为 /usr/local/bin/git.</p>

<h3 id="安装-ruby21">安装 Ruby(2.1)</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre>mkdir /tmp/ruby <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /tmp/ruby
curl --progress ftp://ftp.ruby-lang.org/pub/ruby/2.1/ruby-2.1.10.tar.gz | tar xz
<span class="nb">cd </span>ruby-2.1.9
./configure --disable-install-rdoc
make
make <span class="nv">prefix</span><span class="o">=</span>/usr/local install
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="install-the-bundler-gem">Install the Bundler Gem</h4>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>gem install bundler --no-doc
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="安装-go">安装 Go</h3>

<p>从 GitLab 8.0 开始， http请求是由 gitlab 的 workhorse 处理的，workhorse 是一个 Go 程序。</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>yum install golang golang-bin golang-src
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="配置-gitlab-的系统用户">配置 GitLab 的系统用户</h3>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>adduser --system --shell /bin/bash --comment 'GitLab' --create-home --home-dir /home/git/ git
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>
    <p>In order to include /usr/local/bin to git user’s PATH, one way is to edit the sudoers file. <br />
As root run: <code class="highlighter-rouge">visudo</code></p>

    <p>将</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>改为</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h3 id="安装数据库">安装数据库</h3>

<h4 id="postgresql93">PostgreSQL(9.3)</h4>

<ul>
  <li>
    <p>安装</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>yum remove postgresql
rpm -Uvh http://yum.postgresql.org/9.3/redhat/rhel-6-x86_64/pgdg-centos93-9.3-2.noarch.rpm
yum install postgresql93-server postgresql93-devel postgresql93-contrib
mv /etc/init.d/<span class="o">{</span>postgresql-9.3,postgresql<span class="o">}</span>
service postgresql initdb
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>启动</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>service postgresql start
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>配置自启动</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>chkconfig postgresql on
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>配置用户名&amp;密码</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre>su - postgres
psql -d template1

psql <span class="o">(</span>9.4.3<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.
<span class="gp">template1=# </span>CREATE USER git CREATEDB;
CREATE ROLE
<span class="gp">template1=# </span>CREATE DATABASE gitlabhq_production OWNER git;
CREATE DATABASE
<span class="gp">template1=# </span>CREATE EXTENSION IF NOT EXISTS pg_trgm;
<span class="gp">template1=# </span><span class="se">\q</span>
<span class="nb">exit</span> <span class="c"># exit uid=postgres, return to root</span>
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>配置完成后，尝试用git用户登录</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>sudo -u git psql -d gitlabhq_production
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>检查 pg_trgm extension 是否安装</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>SELECT true AS enabled
FROM pg_available_extensions
WHERE name = 'pg_trgm'
AND installed_version IS NOT NULL;
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>配置权限<br />
/var/lib/pgsql/9.3/data/pg_hba.conf<br />
修改 ident 为 trust</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>host    all             all             127.0.0.1/32            trust
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h4 id="mysql5514-or-later">MySQL(5.5.14 or later)</h4>

<ul>
  <li>
    <p>安装 MySQL ，并设置自启动</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>yum install -y mysql-server mysql-devel
chkconfig mysqld on
service mysqld start
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>版本最低 5.5.14</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>mysql --version
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>Secure your installation</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>mysql_secure_installation
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>Create a user for GitLab</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>CREATE USER 'git'@'localhost' IDENTIFIED BY '$password';
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>设置 使用 INNODB 引擎</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>SET storage_engine=INNODB;
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>如果设置失败，检查下 MySQL config files (e.g. /etc/mysql/<em>.cnf, /etc/mysql/conf.d/</em>) ，是否”innodb = off”.</p>
  </li>
  <li>
    <p>Create the GitLab production database</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`;
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>Grant the GitLab user necessary permissions on the table</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, CREATE TEMPORARY TABLES, DROP, INDEX, ALTER, LOCK TABLES, REFERENCES ON `gitlabhq_production`.* TO 'git'@'localhost';
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>检查下新用户、新数据库</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>sudo -u git -H mysql -u git -p -D gitlabhq_production
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h3 id="安装redis-at-least-redis-28-">安装Redis( at least Redis 2.8 )</h3>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>yum remove redis
yum --enablerepo=remi,remi-test install redis
chkconfig redis on
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>
    <p>配置 redis</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>cp /etc/redis.conf /etc/redis.conf.orig
</pre></td></tr></tbody></table>
</div>
    </div>

    <ul>
      <li>
        <p>禁止通过tcp访问redis，将  port 设置为 0 即可。</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>sed <span class="s1">'s/^port .*/port 0/'</span> /etc/redis.conf.orig | sudo tee /etc/redis.conf
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>Enable Redis socket for default CentOS path:</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="nb">echo</span> <span class="s1">'unixsocket /var/run/redis/redis.sock'</span> | sudo tee -a /etc/redis.conf
<span class="nb">echo</span> -e <span class="s1">'unixsocketperm 0770'</span> | sudo tee -a /etc/redis.conf
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>Create the directory which contains the socket</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>mkdir /var/run/redis
chown redis:redis /var/run/redis
chmod 755 /var/run/redis
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>Persist the directory which contains the socket, if applicable</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="k">if</span> <span class="o">[</span> -d /etc/tmpfiles.d <span class="o">]</span>; <span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'d  /var/run/redis  0755  redis  redis  10d  -'</span> | sudo tee -a /etc/tmpfiles.d/redis.conf
<span class="k">fi</span>
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>重启 Redis ，使设置生效</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>service redis restart
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>将 git 用户加入 redis group</p>

        <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>usermod -aG redis git
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="安装-gitlab-1">安装 Gitlab</h3>

<p>安装到 git 用户的home目录</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre></td><td class="code"><pre><span class="c"># We'll install GitLab into home directory of the user "git"</span>
<span class="nb">cd</span> /home/git

<span class="c"># Clone GitLab repository</span>
sudo -u git -H git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b 8-9-stable gitlab
<span class="c"># 2017-04 9-1-stable 能用了</span>
<span class="c"># sudo -u git -H git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b 9-1-stable gitlab</span>


<span class="c"># Go to GitLab installation folder</span>
<span class="nb">cd</span> /home/git/gitlab

<span class="c"># Copy the example GitLab config</span>
sudo -u git -H cp config/gitlab.yml.example config/gitlab.yml

<span class="c"># Update GitLab config file, follow the directions at top of file</span>
sudo -u git -H editor config/gitlab.yml

<span class="c"># Copy the example secrets file</span>
sudo -u git -H cp config/secrets.yml.example config/secrets.yml
sudo -u git -H chmod 0600 config/secrets.yml

<span class="c"># Make sure GitLab can write to the log/ and tmp/ directories</span>
sudo chown -R git log/
sudo chown -R git tmp/
sudo chmod -R u+rwX,go-w log/
sudo chmod -R u+rwX tmp/

<span class="c"># Make sure GitLab can write to the tmp/pids/ and tmp/sockets/ directories</span>
sudo chmod -R u+rwX tmp/pids/
sudo chmod -R u+rwX tmp/sockets/

<span class="c"># Create the public/uploads/ directory</span>
sudo -u git -H mkdir public/uploads/

<span class="c"># Make sure only the GitLab user has access to the public/uploads/ directory</span>
<span class="c"># now that files in public/uploads are served by gitlab-workhorse</span>
sudo chmod 0700 public/uploads

sudo chmod ug+rwX,o-rwx /home/git/repositories/

<span class="c"># Change the permissions of the directory where CI build traces are stored</span>
sudo chmod -R u+rwX builds/

<span class="c"># Change the permissions of the directory where CI artifacts are stored</span>
sudo chmod -R u+rwX shared/artifacts/

<span class="c"># Copy the example Unicorn config</span>
sudo -u git -H cp config/unicorn.rb.example config/unicorn.rb

<span class="c"># Find number of cores</span>
nproc

<span class="c"># Enable cluster mode if you expect to have a high load instance</span>
<span class="c"># Ex. change amount of workers to 3 for 2GB RAM server</span>
<span class="c"># Set the number of workers to at least the number of cores</span>
sudo -u git -H editor config/unicorn.rb

<span class="c"># Copy the example Rack attack config</span>
sudo -u git -H cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb

<span class="c"># Configure Git global settings for git user</span>
<span class="c"># 'autocrlf' is needed for the web editor</span>
sudo -u git -H git config --global core.autocrlf input

<span class="c"># Disable 'git gc --auto' because GitLab already runs 'git gc' when needed</span>
sudo -u git -H git config --global gc.auto 0

<span class="c"># Configure Redis connection settings</span>
sudo -u git -H cp config/resque.yml.example config/resque.yml

<span class="c"># Change the Redis socket path if you are not using the default CentOS configuration</span>
sudo -u git -H editor config/resque.yml
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="配置数据库连接">配置数据库连接</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="c"># PostgreSQL only:</span>
sudo -u git cp config/database.yml.postgresql config/database.yml

<span class="c"># MySQL only:</span>
sudo -u git cp config/database.yml.mysql config/database.yml

<span class="c"># MySQL and remote PostgreSQL only:</span>
<span class="c"># Update username/password in config/database.yml.</span>
<span class="c"># You only need to adapt the production settings (first part).</span>
<span class="c"># If you followed the database guide then please do as follows:</span>
<span class="c"># Change 'secure password' with the value you have given to $password</span>
<span class="c"># You can keep the double quotes around the password</span>
sudo -u git -H editor config/database.yml

<span class="c"># PostgreSQL and MySQL:</span>
<span class="c"># Make config/database.yml readable to git only</span>
sudo -u git -H chmod o-rwx config/database.yml
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="install-gems">Install Gems</h4>

<p>国内记得改一下 ruby-china 的源，不然很慢</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="nb">cd</span> /home/git/gitlab

<span class="c"># For PostgreSQL (note, the option says "without ... mysql")</span>
sudo -u git -H bundle config build.pg --with-pg-config<span class="o">=</span>/usr/pgsql-9.3/bin/pg_config
sudo -u git -H bundle install --deployment --without development <span class="nb">test </span>mysql aws kerberos

<span class="c"># Or for MySQL (note, the option says "without ... postgres")</span>
sudo -u git -H bundle install --deployment --without development <span class="nb">test </span>postgres aws kerberos
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="install-gitlab-shell">Install GitLab shell</h4>

<p>GitLab Shell is an SSH access and repository management software developed specially for GitLab.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="c"># Run the installation task for gitlab-shell (replace `REDIS_URL` if needed):</span>
sudo -u git -H bundle <span class="nb">exec </span>rake gitlab:shell:install[v3.0.0] <span class="nv">REDIS_URL</span><span class="o">=</span>unix:/var/run/redis/redis.sock <span class="nv">RAILS_ENV</span><span class="o">=</span>production

<span class="c"># By default, the gitlab-shell config is generated from your main GitLab config.</span>
<span class="c"># You can review (and modify) the gitlab-shell config as follows:</span>
sudo -u git -H editor /home/git/gitlab-shell/config.yml

<span class="c"># Ensure the correct SELinux contexts are set</span>
<span class="c"># Read http://wiki.centos.org/HowTos/Network/SecuringSSH</span>
restorecon -Rv /home/git/.ssh
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="install-gitlab-workhorse">Install gitlab-workhorse</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="nb">cd</span> /home/git
sudo -u git -H git clone https://gitlab.com/gitlab-org/gitlab-workhorse.git
<span class="nb">cd </span>gitlab-workhorse
sudo -u git -H git checkout v0.7.5
sudo -u git -H make
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="初始化数据库">初始化数据库</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c"># Go to GitLab installation folder</span>

<span class="nb">cd</span> /home/git/gitlab

sudo -u git -H bundle <span class="nb">exec </span>rake gitlab:setup <span class="nv">RAILS_ENV</span><span class="o">=</span>production

<span class="c"># Type 'yes' to create the database tables.</span>

<span class="c"># When done you see 'Administrator account created:'</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="备份-secretsyml">备份 secrets.yml</h4>

<p>The secrets.yml file stores encryption keys for sessions and secure variables. Backup secrets.yml someplace safe.</p>

<h4 id="配置-gitlab-自启动">配置 GitLab 自启动</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>cp lib/support/init.d/gitlab /etc/init.d/gitlab
cp lib/support/init.d/gitlab.default.example /etc/default/gitlab
chkconfig gitlab on
service gitlab start
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="设置日志备份">设置日志备份</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="检查-gitlab-的环境配置">检查 GitLab 的环境配置</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>sudo -u git -H bundle <span class="nb">exec </span>rake gitlab:env:info <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="compile-assets">Compile assets</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>sudo -u git -H bundle <span class="nb">exec </span>rake assets:precompile <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="启动-gitlab">启动 GitLab</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>service gitlab start
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="配置-web-服务器">配置 Web 服务器</h3>

<h4 id="nginx-1102-1el6-">Nginx( 1.10.2-1.el6 )</h4>

<ul>
  <li>
    <p>安装 Nginx</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>yum update
yum -y install nginx
chkconfig nginx on
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>Site Configuration</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>cp lib/support/nginx/gitlab /etc/nginx/conf.d/gitlab.conf
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>Add nginx user to git group</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>usermod -a -G git nginx
chmod g+rx /home/git/
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>检查 nginx 配置文件</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>nginx -t
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>重启 Nginx</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>service nginx restart
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h4 id="apache">Apache</h4>

<ul>
  <li>
    <p>GitLab-Workhorse</p>

    <p>配合 apache ， workhorse 要做相应修改。Change gitlab_workhorse_options in /etc/default/gitlab to the following:</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>gitlab_workhorse_options="-listenUmask 0 -listenNetwork tcp -listenAddr 127.0.0.1:8181 -authBackend http://127.0.0.1:8080"
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>然后重启GitLab</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>service gitlab restart
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>HTTP 配置</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>yum -y install httpd
chkconfig httpd on
wget -O /etc/httpd/conf.d/gitlab.conf https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/web-server/apache/gitlab-apache22.conf
sed -i <span class="s1">'s/logs\///g'</span> /etc/httpd/conf.d/gitlab.conf
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>HTTPS 配置</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>yum -y install httpd mod_ssl
chkconfig httpd on
wget -O /etc/httpd/conf.d/gitlab.conf https://gitlab.com/gitlab-org/gitlab-recipes/raw/master/web-server/apache/gitlab-ssl-apache22.conf
mv /etc/httpd/conf.d/ssl.conf{,.bak}
sed -i 's/logs\///g' /etc/httpd/conf.d/gitlab.conf
</pre></td></tr></tbody></table>
</div>
    </div>

    <ul>
      <li>make sure the path to your certificates is valid.</li>
      <li>Add LoadModule ssl_module /etc/httpd/modules/mod_ssl.so in /etc/httpd/conf/httpd.conf.</li>
    </ul>
  </li>
  <li>
    <p>SELinux 配置</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>setsebool -P httpd_can_network_connect on
setsebool -P httpd_can_network_relay on
setsebool -P httpd_read_user_content on
semanage -i - &lt;&lt;EOF
fcontext -a -t user_home_dir_t '/home/git(/.*)?'
fcontext -a -t ssh_home_t '/home/git/.ssh(/.*)?'
fcontext -a -t httpd_sys_content_t '/home/git/gitlab/public(/.*)?'
fcontext -a -t httpd_sys_content_t '/home/git/repositories(/.*)?'
EOF
restorecon -R /home/git
</pre></td></tr></tbody></table>
</div>
    </div>

    <ul>
      <li>Note: semanage is part of the policycoreutils-python package.</li>
    </ul>
  </li>
  <li>
    <p>Other httpd security considerations</p>

    <ul>
      <li>
        <p>In /etc/httpd/conf/httpd.conf</p>

        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>ServerTokens Prod
ServerSignature Off
TraceEnable Off
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>mod_ssl 在压缩时候有漏洞</p>

        <p>Apache httpd 2.2.15 (official release), mod_ssl enables compression over SSL by default. 所以要关闭</p>

        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre># add the following line to /etc/sysconfig/httpd.
export OPENSSL_NO_DEFAULT_ZLIB=1
</pre></td></tr></tbody></table>
</div>
        </div>

        <p>httpd 2.2.24 and greater 版本在 httpd.conf 可以设置</p>

        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>SSLCompression Off
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>某些apache mode 要禁用</p>

        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>#LoadModule deflate_module modules/mod_deflate.so
#LoadModule suexec_module modules/mod_suexec.so

</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>重启 apache</p>

        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>service httpd start
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="配置防火墙">配置防火墙</h3>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>lokkit -s http -s https -s ssh
service iptables restart
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="最后检查安装结果">最后检查安装结果</h3>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>cd /home/git/gitlab
sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="首次登陆">首次登陆</h3>

<p>默认管理员是 root 用户， 首次登陆设置密码。</p>

<p>root 用户登录 》 右上角 Admin Area 图标 》 Overview</p>

<p>例如，本次安装完成后，Overview 页面显示组件情况：</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre>GitLab       8.9.11
GitLab Shell 3.0.0
GitLab API v3
Git          2.9.0
Ruby         2.1.10p492
Rails        4.2.7.1
PostgreSQL   9.3.15
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="health-check">Health Check</h4>

<p>root 用户登录 》 右上角 Admin Area 图标 》 Monitoring 》 Health Check</p>

<h2 id="重启-gitlab">重启 Gitlab</h2>

<ul>
  <li>
    <p>Nginx + PostgreSQL 组合</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>service redis start
service postgresql start
service gitlab start
service nginx start
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h2 id="问题-trouble-shooting">问题 Trouble Shooting</h2>

<ul>
  <li>参考<br />
<a href="http://blog.csdn.net/johnnycode/article/details/41947581">http://blog.csdn.net/johnnycode/article/details/41947581</a><br />
<a href="http://axilleas.me/en/blog/2013/selinux-policy-for-nginx-and-gitlab-unix-socket-in-fedora-19/">http://axilleas.me/en/blog/2013/selinux-policy-for-nginx-and-gitlab-unix-socket-in-fedora-19/</a></li>
</ul>

<h3 id="都装好了nginx-不能访问-gitlab-workhorsepermission-denied">都装好了，nginx 不能访问 gitlab-workhorse，permission denied</h3>

<p>访问 Gitlab，提示 403 Forbidden…………</p>

<ul>
  <li>查看日志</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre>/var/log/nginx/gitlab_error.log

2016/11/21 09:59:26 [crit] 611#0: *13 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket failed (13: Permission denied) while connecting to upstream, client: 127.0.0.1, server: your_server_fqdn, request: "GET / HTTP/1.1", upstream: "http://unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket:/", host: "127.0.0.1"
2016/11/21 09:59:26 [error] 611#0: *13 open() "/home/git/gitlab/public/502.html" failed (13: Permission denied), client: 127.0.0.1, server: your_server_fqdn, request: "GET / HTTP/1.1", upstream: "http://unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket/", host: "127.0.0.1"
2016/11/21 10:01:05 [crit] 611#0: *15 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket failed (13: Permission denied) while connecting to upstream, client: 127.0.0.1, server: your_server_fqdn, request: "GET / HTTP/1.1", upstream: "http://unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket:/", host: "127.0.0.1"
2016/11/21 10:01:05 [error] 611#0: *15 open() "/home/git/gitlab/public/502.html" failed (13: Permission denied), client: 127.0.0.1, server: your_server_fqdn, request: "GET / HTTP/1.1", upstream: "http://unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket/", host: "127.0.0.1"
2016/11/21 10:01:11 [crit] 611#0: *17 connect() to unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket failed (13: Permission denied) while connecting to upstream, client: 127.0.0.1, server: your_server_fqdn, request: "GET /favicon.ico HTTP/1.1", upstream: "http://unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket:/favicon.ico", host: "127.0.0.1"
2016/11/21 10:01:11 [error] 611#0: *17 open() "/home/git/gitlab/public/502.html" failed (13: Permission denied), client: 127.0.0.1, server: your_server_fqdn, request: "GET /favicon.ico HTTP/1.1", upstream: "http://unix:/home/git/gitlab/tmp/sockets/gitlab-workhorse.socket/favicon.ico", host: "127.0.0.1"
</pre></td></tr></tbody></table>
</div>
</div>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre>/home/git/gitlab/log/production.log

Cleaning old build artifacts
Started GET "/" for 127.0.0.1 at 2016-11-21 10:11:21 +0800
Processing by RootController#index as */*
Completed 401 Unauthorized in 4ms (ActiveRecord: 0.0ms)
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>
    <p>分析<br />
这是由于Selinux权限控制导致的，发现 socket 文件不能方法，查看socket文件权限描述后面有个点，如下：</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>root@localhost: /home/git/gitlab # ll tmp/sockets
total 0
srwxrwxrwx. 1 git git 0 Nov 21 10:42 gitlab.socket
srwxrwxrwx. 1 git git 0 Nov 21 10:42 gitlab-workhorse.socket
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>解决办法是，关闭selinux，或者配置安全策略</p>
  </li>
</ul>

<h4 id="可选方法关闭selinux">可选方法，关闭Selinux</h4>

<ul>
  <li>
    <p>临时关闭</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre># setenforce 0 #关闭 Selinux  
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>永久关闭<br />
修改 /etc/selinux/config 文件，修改 SELINUX=disabled，重启后查看：</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>getenforce   
Disabled  
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h4 id="可选方法添加-security-module">可选方法，添加 security module</h4>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>yum install -y policycoreutils-{python,devel}
grep nginx /var/log/audit/audit.log | audit2allow -M nginx
semodule -i nginx.pp
usermod -a -G git nginx
chmod g+rx /home/git/
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="gitlab-910">Gitlab 9.1.0</h2>

<h3 id="修改-unicorn-端口">修改 unicorn 端口</h3>

<p>默认 unicorn 端口是 8080，容易和其他app冲突</p>

<ul>
  <li>修改方法</li>
</ul>

<p>/home/git/gitlab/config/unicorn.rb</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>listen "127.0.0.1:8080", :tcp_nopush =&gt; true
改为
listen "127.0.0.1:8888", :tcp_nopush =&gt; true
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="附录">附录</h2>

<h3 id="ldap-设置">LDAP 设置</h3>

<ul>
  <li>参见：
    <ul>
      <li><a href="https://docs.gitlab.com/ce/administration/auth/ldap.html">GitLab Community Edition Authentication and Authorization LDAP</a></li>
      <li><a href="https://stackoverflow.com/questions/18984198/how-to-debug-gitlab-ldap-authentication">How to debug Gitlab LDAP authentication?</a></li>
      <li><a href="https://about.gitlab.com/handbook/support/workflows/ldap/debugging_ldap.html">Debugging LDAP </a></li>
      <li><a href="https://docs.gitlab.com/ee/administration/auth/ldap.html">Gitlab-EE-Admin-LDAP </a></li>
      <li><a href="https://raymii.org/s/tutorials/Gitlab_and_Active_Directory_LDAP_Authentication.html">Gitlab Active Directory LDAP Authentication</a></li>
      <li><a href="http://www.cnblogs.com/silenceli/p/3459234.html">gitlab&amp;fengoffice的ldap配置</a></li>
    </ul>
  </li>
</ul>

<ol>
  <li>在 config/gitlab.yml 中配置 ldap 部分</li>
  <li>重启 Gitlab</li>
</ol>

<h4 id="gitlabyml-中-openldap-配置示例">gitlab.yml 中 openldap 配置示例</h4>

<div class="language-yml highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre></td><td class="code"><pre>  <span class="c1">## LDAP settings</span>
  <span class="c1"># You can inspect a sample of the LDAP users with login access by running:</span>
  <span class="c1">#   bundle exec rake gitlab:ldap:check RAILS_ENV=production</span>
  <span class="s">ldap</span><span class="pi">:</span>
    <span class="s">enabled</span><span class="pi">:</span> <span class="s">true</span>
    <span class="s">servers</span><span class="pi">:</span>
      <span class="c1">##########################################################################</span>
      <span class="c1">#</span>
      <span class="c1"># Since GitLab 7.4, LDAP servers get ID's (below the ID is 'main'). GitLab</span>
      <span class="c1"># Enterprise Edition now supports connecting to multiple LDAP servers.</span>
      <span class="c1">#</span>
      <span class="c1"># If you are updating from the old (pre-7.4) syntax, you MUST give your</span>
      <span class="c1"># old server the ID 'main'.</span>
      <span class="c1">#</span>
      <span class="c1">##########################################################################</span>
      <span class="s">main</span><span class="pi">:</span> <span class="c1"># 'main' is the GitLab 'provider ID' of this LDAP server</span>
        <span class="c1">## label</span>
        <span class="c1">#</span>
        <span class="c1"># A human-friendly name for your LDAP server. It is OK to change the label later,</span>
        <span class="c1"># for instance if you find out it is too large to fit on the web page.</span>
        <span class="c1">#</span>
        <span class="c1"># Example: 'Paris' or 'Acme, Ltd.'</span>
        <span class="s">label</span><span class="pi">:</span> <span class="s1">'</span><span class="s">LDAP'</span>

        <span class="s">host</span><span class="pi">:</span> <span class="s1">'</span><span class="s">localhost'</span>
        <span class="s">port</span><span class="pi">:</span> <span class="s">389</span>
        <span class="s">uid</span><span class="pi">:</span> <span class="s1">'</span><span class="s">uid'</span>
        <span class="c1">#uid: 'sAMAccountName'</span>
        <span class="s">method</span><span class="pi">:</span> <span class="s1">'</span><span class="s">plain'</span> <span class="c1"># "tls" or "ssl" or "plain"</span>
        <span class="s">bind_dn</span><span class="pi">:</span> <span class="s1">'</span><span class="s">cn=Manager,dc=duzzle,dc=com'</span>
        <span class="s">password</span><span class="pi">:</span> <span class="s1">'</span><span class="s">your-pass'</span>

        <span class="c1"># Set a timeout, in seconds, for LDAP queries. This helps avoid blocking</span>
        <span class="c1"># a request if the LDAP server becomes unresponsive.</span>
        <span class="c1"># A value of 0 means there is no timeout.</span>
        <span class="s">timeout</span><span class="pi">:</span> <span class="s">10</span>

        <span class="c1"># This setting specifies if LDAP server is Active Directory LDAP server.</span>
        <span class="c1"># For non AD servers it skips the AD specific queries.</span>
        <span class="c1"># If your LDAP server is not AD, set this to false.</span>
        <span class="s">active_directory</span><span class="pi">:</span> <span class="s">false</span>

        <span class="c1"># If allow_username_or_email_login is enabled, GitLab will ignore everything</span>
        <span class="c1"># after the first '@' in the LDAP username submitted by the user on login.</span>
        <span class="c1">#</span>
        <span class="c1"># Example:</span>
        <span class="c1"># - the user enters 'jane.doe@example.com' and 'p@ssw0rd' as LDAP credentials;</span>
        <span class="c1"># - GitLab queries the LDAP server with 'jane.doe' and 'p@ssw0rd'.</span>
        <span class="c1">#</span>
        <span class="c1"># If you are using "uid: 'userPrincipalName'" on ActiveDirectory you need to</span>
        <span class="c1"># disable this setting, because the userPrincipalName contains an '@'.</span>
        <span class="s">allow_username_or_email_login</span><span class="pi">:</span> <span class="s">false</span>

        <span class="c1"># To maintain tight control over the number of active users on your GitLab installation,</span>
        <span class="c1"># enable this setting to keep new users blocked until they have been cleared by the admin</span>
        <span class="c1"># (default: false).</span>
        <span class="s">block_auto_created_users</span><span class="pi">:</span> <span class="s">false</span>

        <span class="c1"># Base where we can search for users</span>
        <span class="c1">#</span>
        <span class="c1">#   Ex. ou=People,dc=gitlab,dc=example</span>
        <span class="c1">#</span>
        <span class="s">base</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ou=people,dc=your-corp,dc=com'</span>

        <span class="c1"># Filter LDAP users</span>
        <span class="c1">#</span>
        <span class="c1">#   Format: RFC 4515 http://tools.ietf.org/search/rfc4515</span>
        <span class="c1">#   Ex. (employeeType=developer)</span>
        <span class="c1">#</span>
        <span class="c1">#   Note: GitLab does not support omniauth-ldap's custom filter syntax.</span>
        <span class="c1">#</span>
        <span class="s">user_filter</span><span class="pi">:</span> <span class="s1">'</span><span class="s">objectClass=inetOrgPerson'</span>

        <span class="c1"># LDAP attributes that GitLab will use to create an account for the LDAP user.</span>
        <span class="c1"># The specified attribute can either be the attribute name as a string (e.g. 'mail'),</span>
        <span class="c1"># or an array of attribute names to try in order (e.g. ['mail', 'email']).</span>
        <span class="c1"># Note that the user's LDAP login will always be the attribute specified as `uid` above.</span>
        <span class="s">attributes</span><span class="pi">:</span>
          <span class="c1"># The username will be used in paths for the user's own projects</span>
          <span class="c1"># (like `gitlab.example.com/username/project`) and when mentioning</span>
          <span class="c1"># them in issues, merge request and comments (like `@username`).</span>
          <span class="c1"># If the attribute specified for `username` contains an email address,</span>
          <span class="c1"># the GitLab username will be the part of the email address before the '@'.</span>
          <span class="s">username</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">uid'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">userid'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">sAMAccountName'</span><span class="pi">]</span>
          <span class="s">email</span><span class="pi">:</span>    <span class="pi">[</span><span class="s1">'</span><span class="s">mail'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">email'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">userPrincipalName'</span><span class="pi">]</span>

          <span class="c1"># If no full name could be found at the attribute specified for `name`,</span>
          <span class="c1"># the full name is determined using the attributes specified for</span>
          <span class="c1"># `first_name` and `last_name`.</span>
          <span class="s">name</span><span class="pi">:</span>       <span class="s1">'</span><span class="s">cn'</span>
          <span class="s">first_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">givenName'</span>
          <span class="s">last_name</span><span class="pi">:</span>  <span class="s1">'</span><span class="s">sn'</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="使用ip作为服务器地址需要修改host配置">使用IP作为服务器地址，需要修改host配置</h3>

<ul>
  <li>
    <p>修改 nginx 的 server_name 配置为IP值</p>
  </li>
  <li>
    <p>修改 config/gitlab.yml 中 host 为 IP值</p>
  </li>
</ul>

<h3 id="发送通知的邮箱设置">发送通知的邮箱设置</h3>

<p>默认已经安装mail服务器，可以向外发送邮件。</p>

<p>config/gitlab.yml</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>email_from: example@example.com
email_display_name: GitLab
email_reply_to: noreply@example.com
email_subject_suffix: ''
</pre></td></tr></tbody></table>
</div>
</div>

<p>用户收到的邮件显示发件人为：Gitlab<a href="mailto:example@example.com">example@example.com</a></p>

<h4 id="配置外部smtp服务">配置外部smtp服务</h4>

<ul>
  <li>gitlab 9.1.0 , 8.x 试过，可用</li>
</ul>

<p>修改 config/gitlab.yml</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="s">email_from</span><span class="pi">:</span> <span class="s">your_mail@126.com</span>
<span class="s">email_display_name</span><span class="pi">:</span> <span class="s">your_mail@126.com</span>
<span class="s">email_reply_to</span><span class="pi">:</span> <span class="s">your_mail@126.com</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>拷贝 config/intializers/smtp_settings.rb.sample 为 smtp_settings.rb 后修改</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>

  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">delivery_method</span> <span class="o">=</span> <span class="ss">:smtp</span>
  <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">smtp_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">address: </span><span class="s2">"smtp.126.com"</span><span class="p">,</span>
    <span class="ss">port: </span><span class="mi">25</span><span class="p">,</span>
    <span class="ss">user_name: </span><span class="s2">"your_mail@126.com"</span><span class="p">,</span>
    <span class="ss">password: </span><span class="s2">"your_mail_password"</span><span class="p">,</span>
    <span class="ss">domain: </span><span class="s2">"126.com"</span><span class="p">,</span>
    <span class="ss">authentication: :login</span><span class="p">,</span>
    <span class="ss">enable_starttls_auto: </span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">openssl_verify_mode: </span><span class="s1">'none'</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>配置完，root 用户登录 》 右上角 Admin Area 图标 》 Monitoring 》 Health Check<br />
看看有没错误。</p>

<h3 id="检查gitlab状态">检查Gitlab状态</h3>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>sudo -u git -H bundle exec rake gitlab:env:info RAILS_ENV=production

sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="使用-ssh-来-clone-代码库的时候提示输入-git-用户的密码">使用 ssh 来 clone 代码库的时候，提示输入 git 用户的密码</h3>

<ul>
  <li>
    <p>前提<br />
正确配置了 ssh 的公钥， 右上角用户图标 &gt; settings &gt; SSH Keys</p>
  </li>
  <li>
    <p>原因</p>
    <ul>
      <li>服务器上sshd没配置好，或者，</li>
      <li>git 的 HOME 目录或者 .ssh 目录的读写权限没配置好
        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>chmod 700 /home/git/.ssh
chmod 600 /home/git/.ssh/authorized_keys
chmod go-w /home/git
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="gitlab-pages-配置">Gitlab Pages 配置</h3>

<ul>
  <li>参考：
    <ul>
      <li><a href="https://gitlab.com/gitlab-org/gitlab-pages">Gitlab Pages Project</a></li>
      <li><a href="https://docs.gitlab.com/ce/administration/pages/">https://docs.gitlab.com/ce/administration/pages/</a></li>
      <li><a href="https://docs.gitlab.com/ee/user/project/pages/">https://docs.gitlab.com/ee/user/project/pages/</a></li>
      <li><a href="https://docs.gitlab.com/ee/administration/pages/">https://docs.gitlab.com/ee/administration/pages/</a></li>
      <li><a href="https://docs.gitlab.com/ee/user/project/pages/index.html">https://docs.gitlab.com/ee/user/project/pages/index.html</a></li>
    </ul>
  </li>
</ul>

<h4 id="从源码安装-gitlab-pages">从源码安装 Gitlab Pages</h4>

<h5 id="安装配置-go">安装&amp;配置 Go</h5>

<p>Go-lang 安装好，$GOPATH 配置好</p>

<p>例如</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>vim /etc/profile.d/custom.sh

# 添加
export PATH=$PATH:/usr/local/go/bin:/opt/go/bin
export GOPATH=/opt/go
</pre></td></tr></tbody></table>
</div>
</div>

<h5 id="下载编译-gitlab-pages-源码">下载&amp;编译 Gitlab Pages 源码</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre># go get gitlab.com/gitlab-org/gitlab-pages
# cd $GOPATH/src/gitlab.com/gitlab-org/gitlab-pages/

# git checkout tag-your-want
# git describe --tags --abbrev=0
v0.4.2

# git rev-parse --short HEAD
dccd0f2

# go build -o gitlab-pages --ldflags="-X main.VERSION=v0.4.2 -X main.REVISION=dccd0f2"

# 编译完成，试一下
# ./gitlab-pages -version
</pre></td></tr></tbody></table>
</div>
</div>

<h5 id="安装-gitlab-pages">安装 Gitlab Pages</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>cp $GOPATH/src/gitlab.com/gitlab-org/gitlab-pages/ /home/git
chown -R git.git /home/git/gitlab-pages/
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>【注】 service gitlab start 启动时，会在 gitlab 的同一目录中找 gitlab-pages
    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>/home/git/source/gitlab-ce/lib/support/init.d/gitlab
Line 46: gitlab_pages_dir=$(cd $app_root/../gitlab-pages 2&gt; /dev/null &amp;&amp; pwd)
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h5 id="配置-gitlab-pages-完成-重启-gitlab">配置 Gitlab Pages 完成， 重启 Gitlab</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre>$ service gitlab restart
Shutting down GitLab Unicorn
Shutting down GitLab Sidekiq
Shutting down GitLab Workhorse
Shutting down gitlab-pages
.
GitLab is not running.
Starting GitLab Unicorn
Starting GitLab Sidekiq
Starting GitLab Workhorse
Starting GitLab Pages
.
The GitLab Unicorn web server with pid 6414 is running.
The GitLab Sidekiq job dispatcher with pid 6485 is running.
The GitLab Workhorse with pid 6447 is running.
The GitLab Pages with pid  is running.
GitLab and all its components are up and running.
</pre></td></tr></tbody></table>
</div>
</div>

<h5 id="todo-虽然-gitlab-pages-启动了仍然无法访问到">TODO… 虽然 Gitlab-pages 启动了，仍然无法访问到</h5>

<p>要将  /home/git/gitlab/lib/support/nginx/gitlab-pages 配置到 nginx</p>

<p>用 nginx 反向代理到 gitlab-pages 这个 Go http 服务器。</p>

<p>只是在局域网中使用，没有配置 domain，gitlab-pages 的 domain 逻辑反而成了麻烦，无法访问的项目页面。</p>

<h4 id="使用-nginx-代替-gitlab-pages">使用 nginx 代替 Gitlab-pages</h4>

<p>在局域网中应为domain不熟悉，gitlab-pages 没配置起来。</p>

<p>不讲究，就先用nginx代替了。</p>

<h5 id="1-gitlab启动时不再启动-gitlab-pages">1） gitlab启动时，不再启动 gitlab-pages</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre># /etc/default/gitlab
gitlab_pages_enabled=false
</pre></td></tr></tbody></table>
</div>
</div>

<p>service gitlab start 启动的时候，就不会把 gitlab-pages deamon 运行起来了</p>

<h5 id="2-配置-nginx">2） 配置 nginx</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><pre>## GitLab
##

## Pages serving host
server {
  listen 8091;
  #listen 0.0.0.0:80;
  #listen [::]:80 ipv6only=on;

  ## Replace this with something like pages.gitlab.com
  server_name 192.168.251.72;
  #server_name ~^.*\.YOUR_GITLAB_PAGES\.DOMAIN$;

  ## Individual nginx logs for GitLab pages
  access_log  /var/log/nginx/gitlab_pages_access.log;
  error_log   /var/log/nginx/gitlab_pages_error.log;

  # WI: DO NOT USE gitlab-org/gitlab-pages , no idea about how to config this Go Server
  #location / {
  #  proxy_set_header    Host                $http_host;
  #  proxy_set_header    X-Real-IP           $remote_addr;
  #  proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
  #  proxy_set_header    X-Forwarded-Proto   $scheme;
  #  # The same address as passed to GitLab Pages: `-listen-proxy`
  #  proxy_pass          http://localhost:8090/;
  #}

  location / {
    root /home/git/gitlab/shared/pages;
    index  index.html index.htm;
  }

  # Define custom error pages
  error_page 403 /403.html;
  error_page 404 /404.html;
}
</pre></td></tr></tbody></table>
</div>
</div>

<h5 id="3-配置-gitlab">3） 配置 gitlab</h5>

<p>/home/git/gitlab/config/gitlab.yml</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre>  <span class="c1">## GitLab Pages</span>
  <span class="s">pages</span><span class="pi">:</span>
    <span class="s">enabled</span><span class="pi">:</span> <span class="s">true</span>
    <span class="c1"># The location where pages are stored (default: shared/pages).</span>
    <span class="c1"># path: shared/pages</span>

    <span class="c1"># The domain under which the pages are served:</span>
    <span class="c1"># http://group.example.com/project</span>
    <span class="c1"># or project path can be a group page: group.example.com</span>
    <span class="s">host</span><span class="pi">:</span> <span class="s">192.168.1.101</span>
    <span class="s">port</span><span class="pi">:</span> <span class="s">8091</span>
    <span class="c1">#host: example.com</span>
    <span class="c1">#port: 80 # Set to 443 if you serve the pages with HTTPS</span>
    <span class="s">https</span><span class="pi">:</span> <span class="s">false</span> <span class="c1"># Set to true if you serve the pages with HTTPS</span>

</pre></td></tr></tbody></table>
</div>
</div>

<h5 id="4-修改-gitlab-代码">4） 修改 gitlab 代码</h5>

<ul>
  <li>app/models/project.rb
    <div class="language-ruby highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">pages_url</span>
  <span class="n">subdomain</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">url_path</span> <span class="o">=</span> <span class="n">full_path</span><span class="p">.</span><span class="nf">partition</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>

  <span class="c1"># 直接返回nginx上配置的地址，&lt;githost&gt;/&lt;group&gt;/&lt;project&gt;/pages 页面上显示如下地址</span>
  <span class="k">return</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Gitlab</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">pages</span><span class="p">.</span><span class="nf">url</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">subdomain</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">url_path</span><span class="si">}</span><span class="s2">/public/"</span>
    
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
</ul>

<h5 id="5-重启-gitlab">5） 重启 gitlab</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>service gitlab restart
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="gitlab-runner">Gitlab Runner</h3>

<ul>
  <li><a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner">gitlab-runner project</a></li>
  <li><a href="https://docs.gitlab.com/runner/install/linux-repository.html">Install GitLab Runner using the official GitLab repositories</a></li>
  <li><a href="https://docs.gitlab.com/runner/">GitLab Runner</a></li>
  <li><a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/commands/README.md">GitLab Runner Commands</a></li>
  <li><a href="http://blog.csdn.net/lusyoe/article/details/52714121">http://blog.csdn.net/lusyoe/article/details/52714121</a></li>
</ul>

<p>要使用 Gitlab-ci ，必须安装 Gitlab Runner</p>

<h4 id="从源码安装-gitlab-runner">从源码安装 Gitlab-Runner</h4>

<h5 id="安装配置-go-1">安装&amp;配置 Go</h5>

<p>Go-lang 安装好，$GOPATH 配置好</p>

<p>例如</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>vim /etc/profile.d/custom.sh

# 添加
export PATH=$PATH:/usr/local/go/bin:/opt/go/bin
export GOPATH=/opt/go
</pre></td></tr></tbody></table>
</div>
</div>

<h5 id="下载-gitlab-runner-源码">下载 Gitlab-Runner 源码</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>go get gitlab.com/gitlab-org/gitlab-ci-multi-runner
cd $GOPATH/src/gitlab.com/gitlab-org/gitlab-ci-multi-runner/

# 使用 gitlab-ci 的 9-1-stable 来配合 Gitlab 的 9-1-stable
git checkout 9-1-stable
</pre></td></tr></tbody></table>
</div>
</div>

<h5 id="编译安装-gitlab-runner">编译&amp;安装 Gitlab-Runner</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>make deps
make install
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>注：make 过程中可能要下载 https://gitlab-ci-multi-runner-downloads.s3.amazonaws.com/master/docker/prebuilt-x86_64.tar.xz ，可能要翻墙</li>
</ul>

<h5 id="前台方式启动-gitlab-runner">前台方式启动 gitlab-runner</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>gitlab-ci-multi-runner run
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="gitlab-runner-安装为后台-service">Gitlab-Runner 安装为后台 service</h4>

<p>参考： <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/commands/README.md#service-related-commands">https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/commands/README.md#service-related-commands</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>gitlab-ci-multi-runner install --user<span class="o">=</span>root --working-directory<span class="o">=</span>/home/git
</pre></td></tr></tbody></table>
</div>
</div>

<p>效果：</p>
<ol>
  <li>生成 /etc/rc.d/init.d/gitlab-runner ，可以使用 service gitlab-runner start/stop/restart/status</li>
  <li>设置为系统启动就运行，可以用  chkconfig –list gitlab-runner  看看</li>
  <li>在 Gitlab 网站 运行 pipeline，会在 /home/git/builds 目录中checkout代码并编译，类似 jenkins 的 jobs 目录。</li>
</ol>

<ul>
  <li>【注】： 如果要调整配置，或者 install 错了，可以执行 gitlab-ci-multi-runner uninstall 来删除service</li>
</ul>

<h4 id="在-gitlab-中使用-gitlab-runner-shared-runner">在 Gitlab 中使用 Gitlab-runner shared runner</h4>

<h5 id="创建-runner-实例">创建 runner 实例</h5>

<p>参照如下例子，配置信息创建后保存在 /etc/gitlab-runner/config.toml 【root 用户 run】 或者， $HOME/.gitlab-runner/config.toml 【非 root 用户 run】</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></td><td class="code"><pre><span class="gp">shell&gt; </span>gitlab-ci-multi-runner register

WARNING: Running <span class="k">in </span>user-mode.
WARNING: The user-mode requires you to manually start builds processing:
WARNING: <span class="nv">$ </span>gitlab-runner run
WARNING: Use sudo <span class="k">for </span>system-mode:
WARNING: <span class="nv">$ </span>sudo gitlab-runner...

Please enter the gitlab-ci coordinator URL <span class="o">(</span>e.g. https://gitlab.com/<span class="o">)</span>:
http://192.168.1.101:9088

Please enter the gitlab-ci token <span class="k">for </span>this runner:
6WtTi51kQ1ExP4y-JB80d   <span class="c"># 在 Gitlab admin area &gt; Overview &gt; Runners &gt; Registration token</span>

Please enter the gitlab-ci description <span class="k">for </span>this runner:
<span class="o">[</span>127.0.0.1]: shared-runner

Please enter the gitlab-ci tags <span class="k">for </span>this runner <span class="o">(</span>comma separated<span class="o">)</span>:
shared

Whether to run untagged builds <span class="o">[</span><span class="nb">true</span>/false]:
<span class="o">[</span><span class="nb">false</span><span class="o">]</span>: <span class="nb">true

</span>Whether to lock Runner to current project <span class="o">[</span><span class="nb">true</span>/false]:
<span class="o">[</span><span class="nb">false</span><span class="o">]</span>:
Registering runner... succeeded                     <span class="nv">runner</span><span class="o">=</span>6WtTi51k

Please enter the executor: docker, docker-ssh, shell, ssh, docker+machine, parallels, virtualbox, docker-ssh+machine, kubernetes:
shell

Runner registered successfully. Feel free to start it, but <span class="k">if </span>it<span class="s1">'s running already the config should be automatically reloaded!

</span></pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>另外一个例子</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre>Running <span class="k">in </span>system-mode.

Please enter the gitlab-ci coordinator URL <span class="o">(</span>e.g. https://gitlab.com/ci<span class="o">)</span>:
http://192.168.1.2/ci   // 在这里输入gitlab安装的服务器ip/ci 即可
Please enter the gitlab-ci token <span class="k">for </span>this runner:
eaYyokc57xxZbzAsoshT    // 这里的token可通过Gitlab上的项目Runners选项查看，在下面贴一张截图
Please enter the gitlab-ci description <span class="k">for </span>this runner:
<span class="o">[</span>E5]: spring-demo       // 这里填写一个描述信息，不太重要，看着填吧
Please enter the gitlab-ci tags <span class="k">for </span>this runner <span class="o">(</span>comma separated<span class="o">)</span>:
demo                    // 在这里填写tag信息，多个tag可通过逗号,分割。
Registering runner... succeeded                     <span class="nv">runner</span><span class="o">=</span>eaYyokc5
Please enter the executor: docker, docker-ssh, parallels, shell, ssh, virtualbox, docker+machine, docker-ssh+machine:
shell                   // 在这里需要输入runner的执行方式，因为我的Gitlab和runner是安装在同一台服务器上的，直接输入shell
Runner registered successfully. Feel free to start it, but <span class="k">if </span>it<span class="s1">'s running already the config should be automatically reloaded!
// 出现这样信息表示服务端的配置就已经成功结束了，如果需要使用到自动构建，还需要再添加一个配置文件，下面说说这个。
</span></pre></td></tr></tbody></table>
</div>
</div>

<h5 id="启动-runner-服务">启动 runner 服务</h5>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>gitlab-ci-multi-runner run
</pre></td></tr></tbody></table>
</div>
</div>

<h5 id="在项目中创建-gitlab-ciyml">在项目中创建 .gitlab-ci.yml</h5>

<p>项目首页 &gt; Project &gt; CI configuration</p>

<h5 id="手动执行-ci">手动执行 CI</h5>

<p>项目首页 &gt; Pipelines</p>

<h3 id="ghost-user">Ghost User</h3>

<p>如果Gitlab 管理员删除掉一个用户，系统会创建一个幽灵用户（Ghost User）（如果之前没有），将所有被删用户的issue都只给Ghost 用户。</p>

<p>该用户很牛，无法登陆，无法被root用户删除。</p>

<p>幽灵用户的自述：</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>This is a "Ghost User", created to hold all issues authored by users that have since been deleted. This user cannot be removed.
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="关闭注册">关闭注册</h3>

<ol>
  <li>访问 admin/application_settings</li>
  <li>Sign-up Restrictions &gt; Sign-up Enable 勾掉</li>
  <li>Save</li>
</ol>

<ul>
  <li><strong>注意</strong> 关闭注册之后， 之前没登录过度ldap用户也是不能登入。</li>
</ul>

<h3 id="gitlab-汉化">Gitlab 汉化</h3>

<p>参见 <a href="https://gitlab.com/larryli/gitlab/">GitLab 中文社区版 </a></p>

<h3 id="关闭用户创建group的权限">关闭用户创建Group的权限</h3>

<ul>
  <li>参考：
    <ul>
      <li><a href="https://docs.gitlab.com/ce/workflow/groups.html#allowing-only-admins-to-create-groups">https://docs.gitlab.com/ce/workflow/groups.html#allowing-only-admins-to-create-groups</a></li>
      <li><a href="https://stackoverflow.com/a/38601118">https://stackoverflow.com/a/38601118</a></li>
    </ul>
  </li>
</ul>

<p>Gitlab 默认所有用户都有创建 Group 的权限，关闭方法如下：</p>

<p>修改 gitlab/config/gitlab.yml</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="s">gitlab</span><span class="pi">:</span>
  <span class="s">default_can_create_group</span><span class="pi">:</span> <span class="s">false</span>  <span class="c1"># default: true</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>重启之后，再创建新用户，就不再有 CREATE GROUP 的权限了。</p>

<font color="red">但是，之前的老用户仍然有 CREATE GROUP 的权限。</font>

<h4 id="去除现有用户的-create-group-的权限">去除现有用户的 CREATE GROUP 的权限</h4>

<ul>
  <li>参考：
    <ul>
      <li><a href="https://stackoverflow.com/a/33278917">https://stackoverflow.com/a/33278917</a></li>
    </ul>
  </li>
</ul>

<ol>
  <li>Enter the Admin control panel</li>
  <li>Select ‘Users’</li>
  <li>Select the user(s) in question and click ‘Edit’</li>
  <li>Scroll down to ‘Access’ and un-tick ‘Can Create Group’</li>
</ol>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags#cm" title="Pages tagged cm" class="tag"><span class="term">cm</span></a><a href="/tags#git" title="Pages tagged git" class="tag"><span class="term">git</span></a><a href="/tags#gitlab" title="Pages tagged gitlab" class="tag"><span class="term">gitlab</span></a></span>
        
        
      </footer>
    </div><!-- /.entry-content -->
    
    
    
  </article>
</div><!-- /#main -->
</div><!-- post container -->














<script type="text/javascript">
  // embeded-iframe
  $(window).load(function(){
    $('.embeded-iframe').each(function(){
      $(this).height($(this).contents().find('html').height());
    });
  });
</script>





<div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2023 wi. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://github.com/aron-bordin/neo-hpstr-jekyll-theme" rel="nofollow">Neo-HPSTR Theme</a>.</span>

<script src="/assets/js/main.js?20230725301728281823445"></script>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
