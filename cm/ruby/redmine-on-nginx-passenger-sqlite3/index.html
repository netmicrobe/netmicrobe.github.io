<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>在 nginx + passenger + sqlite3 上使用 redmine &#8211; wi's Tech Blog</title>
<meta name="description" content="notes, articles, or reproduced">
<meta name="keywords" content="ruby, rails, nginx, passenger, redmine">



<!-- Open Graph -->
<meta property="og:locale" content="zh_CN">
<meta property="og:type" content="article">
<meta property="og:title" content="在 nginx + passenger + sqlite3 上使用 redmine">
<meta property="og:description" content="notes, articles, or reproduced">
<meta property="og:url" content="/cm/ruby/redmine-on-nginx-passenger-sqlite3/">
<meta property="og:site_name" content="wi's Tech Blog">
<meta property="og:image" content="/images/images/avatar.png">





<link rel="canonical" href="/cm/ruby/redmine-on-nginx-passenger-sqlite3/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="wi's Tech Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->

<meta http-equiv="cleartype" content="on">

<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="/assets/js/scripts.min.js"></script>

<!-- table of content -->
<script type="text/javascript" src="/assets/js/vendor/toc.js"></script>


<!-- Load Modernizr -->
<script type="text/javascript" src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Mathjax Support -->
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body>

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><i class="fa fa-bars"></i></a></li>
      <li class="header-item-title">
        <a href="/">
          
            <img class="logo" src="/images/avatar.png" alt="wi's Tech Blog">
          
          <a href="/" class="title"> wi's Tech Blog</a>
        </a>
      </li>
      
        
        


        
            
                <li class="header-item "><a href="/favorites">fav</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/categories">Categories</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/tags">Tags</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/">Home</a></li>
            
        
      
      <li class="header-item"><a href="/search"><i class="fa fa-search"></i></a></li>
    </ul>
  </div>



<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="/"><h3>Home</h3></a></li>
      
    
      
        <li><a href="/tags"><h3>Tags</h3></a></li>
      
    
      
        <li><a href="/categories"><h3>Categories</h3></a>
          <ul>
            
              
                <li><a href="/categories/#UML">UML</a></li>
            
              
                <li><a href="/categories/#Windows">Windows</a></li>
            
              
                <li><a href="/categories/#adb">adb</a></li>
            
              
                <li><a href="/categories/#adt">adt</a></li>
            
              
                <li><a href="/categories/#android">android</a></li>
            
              
                <li><a href="/categories/#apache">apache</a></li>
            
              
                <li><a href="/categories/#apple">apple</a></li>
            
              
                <li><a href="/categories/#bat">bat</a></li>
            
              
                <li><a href="/categories/#blog">blog</a></li>
            
              
                <li><a href="/categories/#blog_sample">blog_sample</a></li>
            
              
                <li><a href="/categories/#browser">browser</a></li>
            
              
                <li><a href="/categories/#burpsuite">burpsuite</a></li>
            
              
                <li><a href="/categories/#centos">centos</a></li>
            
              
                <li><a href="/categories/#chrome">chrome</a></li>
            
              
                <li><a href="/categories/#cm">cm</a></li>
            
              
                <li><a href="/categories/#common">common</a></li>
            
              
                <li><a href="/categories/#css">css</a></li>
            
              
                <li><a href="/categories/#cygwin">cygwin</a></li>
            
              
                <li><a href="/categories/#database">database</a></li>
            
              
                <li><a href="/categories/#db">db</a></li>
            
              
                <li><a href="/categories/#dev">dev</a></li>
            
              
                <li><a href="/categories/#device">device</a></li>
            
              
                <li><a href="/categories/#diff">diff</a></li>
            
              
                <li><a href="/categories/#disk">disk</a></li>
            
              
                <li><a href="/categories/#diy">diy</a></li>
            
              
                <li><a href="/categories/#dns">dns</a></li>
            
              
                <li><a href="/categories/#doc">doc</a></li>
            
              
                <li><a href="/categories/#docker">docker</a></li>
            
              
                <li><a href="/categories/#efi">efi</a></li>
            
              
                <li><a href="/categories/#emacs">emacs</a></li>
            
              
                <li><a href="/categories/#email">email</a></li>
            
              
                <li><a href="/categories/#emulator">emulator</a></li>
            
              
                <li><a href="/categories/#english">english</a></li>
            
              
                <li><a href="/categories/#esxi">esxi</a></li>
            
              
                <li><a href="/categories/#excel">excel</a></li>
            
              
                <li><a href="/categories/#exsi">exsi</a></li>
            
              
                <li><a href="/categories/#favorites">favorites</a></li>
            
              
                <li><a href="/categories/#ftp">ftp</a></li>
            
              
                <li><a href="/categories/#game">game</a></li>
            
              
                <li><a href="/categories/#git">git</a></li>
            
              
                <li><a href="/categories/#gitlab">gitlab</a></li>
            
              
                <li><a href="/categories/#go">go</a></li>
            
              
                <li><a href="/categories/#golang">golang</a></li>
            
              
                <li><a href="/categories/#hardware">hardware</a></li>
            
              
                <li><a href="/categories/#ide">ide</a></li>
            
              
                <li><a href="/categories/#internet">internet</a></li>
            
              
                <li><a href="/categories/#java">java</a></li>
            
              
                <li><a href="/categories/#javascript">javascript</a></li>
            
              
                <li><a href="/categories/#jekyll">jekyll</a></li>
            
              
                <li><a href="/categories/#jenkins">jenkins</a></li>
            
              
                <li><a href="/categories/#jmeter">jmeter</a></li>
            
              
                <li><a href="/categories/#kate">kate</a></li>
            
              
                <li><a href="/categories/#kde">kde</a></li>
            
              
                <li><a href="/categories/#ldap">ldap</a></li>
            
              
                <li><a href="/categories/#learn">learn</a></li>
            
              
                <li><a href="/categories/#learning">learning</a></li>
            
              
                <li><a href="/categories/#links">links</a></li>
            
              
                <li><a href="/categories/#linux">linux</a></li>
            
              
                <li><a href="/categories/#living">living</a></li>
            
              
                <li><a href="/categories/#mac">mac</a></li>
            
              
                <li><a href="/categories/#mac-os">mac-os</a></li>
            
              
                <li><a href="/categories/#macos">macos</a></li>
            
              
                <li><a href="/categories/#mail">mail</a></li>
            
              
                <li><a href="/categories/#manjaro">manjaro</a></li>
            
              
                <li><a href="/categories/#markdown">markdown</a></li>
            
              
                <li><a href="/categories/#maven">maven</a></li>
            
              
                <li><a href="/categories/#memcached">memcached</a></li>
            
              
                <li><a href="/categories/#microsoft">microsoft</a></li>
            
              
                <li><a href="/categories/#moco">moco</a></li>
            
              
                <li><a href="/categories/#mysql">mysql</a></li>
            
              
                <li><a href="/categories/#nas">nas</a></li>
            
              
                <li><a href="/categories/#ndk">ndk</a></li>
            
              
                <li><a href="/categories/#netbean">netbean</a></li>
            
              
                <li><a href="/categories/#network">network</a></li>
            
              
                <li><a href="/categories/#netwrok">netwrok</a></li>
            
              
                <li><a href="/categories/#nginx">nginx</a></li>
            
              
                <li><a href="/categories/#nodejs">nodejs</a></li>
            
              
                <li><a href="/categories/#notepad++">notepad++</a></li>
            
              
                <li><a href="/categories/#office">office</a></li>
            
              
                <li><a href="/categories/#open-course">open-course</a></li>
            
              
                <li><a href="/categories/#openkm">openkm</a></li>
            
              
                <li><a href="/categories/#openwrt">openwrt</a></li>
            
              
                <li><a href="/categories/#outlook">outlook</a></li>
            
              
                <li><a href="/categories/#pdf">pdf</a></li>
            
              
                <li><a href="/categories/#perl">perl</a></li>
            
              
                <li><a href="/categories/#phone">phone</a></li>
            
              
                <li><a href="/categories/#php">php</a></li>
            
              
                <li><a href="/categories/#postgresql">postgresql</a></li>
            
              
                <li><a href="/categories/#product">product</a></li>
            
              
                <li><a href="/categories/#python">python</a></li>
            
              
                <li><a href="/categories/#rails">rails</a></li>
            
              
                <li><a href="/categories/#redmine">redmine</a></li>
            
              
                <li><a href="/categories/#regex">regex</a></li>
            
              
                <li><a href="/categories/#router">router</a></li>
            
              
                <li><a href="/categories/#ruby">ruby</a></li>
            
              
                <li><a href="/categories/#search-engine">search-engine</a></li>
            
              
                <li><a href="/categories/#security">security</a></li>
            
              
                <li><a href="/categories/#sed">sed</a></li>
            
              
                <li><a href="/categories/#ssh">ssh</a></li>
            
              
                <li><a href="/categories/#streaming">streaming</a></li>
            
              
                <li><a href="/categories/#study">study</a></li>
            
              
                <li><a href="/categories/#subversion">subversion</a></li>
            
              
                <li><a href="/categories/#tcpdump">tcpdump</a></li>
            
              
                <li><a href="/categories/#tech">tech</a></li>
            
              
                <li><a href="/categories/#testing">testing</a></li>
            
              
                <li><a href="/categories/#testlink">testlink</a></li>
            
              
                <li><a href="/categories/#text">text</a></li>
            
              
                <li><a href="/categories/#tomcat">tomcat</a></li>
            
              
                <li><a href="/categories/#ubuntu">ubuntu</a></li>
            
              
                <li><a href="/categories/#ufw">ufw</a></li>
            
              
                <li><a href="/categories/#vbs">vbs</a></li>
            
              
                <li><a href="/categories/#vim">vim</a></li>
            
              
                <li><a href="/categories/#virtual-box">virtual-box</a></li>
            
              
                <li><a href="/categories/#virtualbox">virtualbox</a></li>
            
              
                <li><a href="/categories/#virtualization">virtualization</a></li>
            
              
                <li><a href="/categories/#vm">vm</a></li>
            
              
                <li><a href="/categories/#vpn">vpn</a></li>
            
              
                <li><a href="/categories/#web">web</a></li>
            
              
                <li><a href="/categories/#windows">windows</a></li>
            
              
                <li><a href="/categories/#xampp">xampp</a></li>
            
              
                <li><a href="/categories/#收藏夹">收藏夹</a></li>
            
              
                <li><a href="/categories/#测试工具">测试工具</a></li>
            
              
                <li><a href="/categories/#玩机">玩机</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="/favorites"><h3>fav</h3></a></li>
      
    
  </ul>
</nav>




<div id="post" >
<div id="main" role="main" >
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">在 nginx + passenger + sqlite3 上使用 redmine</h1>
      
        <h3><span class="entry-date date published updated"><time datetime="2018-03-20T00:00:00+08:00">March 20, 2018</time></span></h3>
      
      
      
      
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 60);
  return false
})

$(".toc-button").on('click', function(){
  $(".toc").toggle();
});


$(window).click(function(evt){
  if( !evt.target.matches('.toc') 
      && !evt.target.matches('.toc>ul') 
      && !evt.target.matches('.toc-button') ) {
    $('.toc').each(function(){
      if( $(this).is(":visible") ) {
        $(this).hide();
      }
    });
  }
});

});
</script>

<div class="float-toc">
    <i class="toc-button fa fa-list-ol" aria-hidden="true"></i>
  <div id="toc"></div>
</div>

      
      
      <h2 id="安装的成功案例">安装的成功案例</h2>

<ol>
  <li>案例一</li>
</ol>

<div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre>iptables    开放nginx 80端口（Redmine<span class="o">)</span>
rvm 1.29.4         /usr/local/rvm
ruby 2.3.7p456
Imagemagick  /opt/_installer/Imagemagick/ImageMagick-6.9.10-86

nginx-1.14.0       /opt/nginx        service nginx start/stop
passenger 5.3.3

mysql 5.1.73     service mysqld start/stop

redmine 3.3.3.stable
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="rvm">rvm</h2>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre>gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
\curl -sSL https://get.rvm.io | sudo bash -s stable
usermod -a -G rvm root
mkdir -p /root/.rvm/user/
echo "ruby_url=https://cache.ruby-china.org/pub/ruby" &gt; ~/.rvm/user/db
source /etc/profile.d/rvm.sh
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="重启shell">重启shell</h2>

<h2 id="利用-rvm-安装-ruby">利用 rvm 安装 ruby</h2>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre>rvm --version
rvm list known
rvm install 2.3
ruby --version
rvm use 2.3 --default
ruby --version
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="创建sqlite3-db-文件">创建sqlite3 db 文件</h2>

<p>CentOS 6.9 自带 sqlite3，不需要安装</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre>cd redmine-home-dir
sqlite3 db/redmine.sqlite3

sqlite&gt; .database
seq  name             file
---  ---------------  ----------------------------------------------------------
0    main             /opt/redmine/redmine33xc/db/redmine.sqlite3
sqlite&gt; .quit


</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="redmine-config">redmine config</h2>

<p>config/database.yml</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>production:
  adapter: sqlite3
  database: db/redmine.sqlite3
  encoding: utf8
</pre></td></tr></tbody></table>
</div>
</div>

<p>【适用国内】gem sources -r https://rubygems.org/ -a http://gems.ruby-china.org/</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre>gem install bundler
yum install -y mysql-devel
yum install -y ImageMagick ImageMagick-devel
bundle install --without development test
bundle exec rake generate_secret_token
RAILS_ENV=production bundle exec rake db:migrate
RAILS_ENV=production bundle exec rake redmine:load_default_data
</pre></td></tr></tbody></table>
</div>
</div>

<p>【测试】</p>
<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>bundle exec rails server webrick -e production -b 192.168.1.101
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="nginx--passenger">Nginx + Passenger</h2>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>gem install passenger --no-rdoc --no-ri
yum install -y libcurl-devel
# 利用 passenger 编译安装 nginx，因为要支持负载均衡的功能，重新编译nginx
passenger-install-nginx-module --prefix=/opt/nginx
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="nginx-配置-nginxconf">【nginx 配置】 nginx.conf</h3>

<div class="language-conf highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="n">user</span>  <span class="n">root</span>;
<span class="n">pid</span>        <span class="n">logs</span>/<span class="n">nginx</span>.<span class="n">pid</span>;
...

<span class="n">http</span> {
    <span class="n">passenger_user_switching</span> <span class="n">off</span>;
    <span class="n">passenger_default_user</span> <span class="n">root</span>;
    <span class="n">passenger_root</span> /<span class="n">usr</span>/<span class="n">local</span>/<span class="n">rvm</span>/<span class="n">gems</span>/<span class="n">ruby</span>-<span class="m">2</span>.<span class="m">3</span>.<span class="m">4</span>/<span class="n">gems</span>/<span class="n">passenger</span>-<span class="m">5</span>.<span class="m">2</span>.<span class="m">0</span>;
    <span class="n">passenger_ruby</span> /<span class="n">usr</span>/<span class="n">local</span>/<span class="n">rvm</span>/<span class="n">gems</span>/<span class="n">ruby</span>-<span class="m">2</span>.<span class="m">3</span>.<span class="m">4</span>/<span class="n">wrappers</span>/<span class="n">ruby</span>;
    <span class="n">passenger_app_env</span> <span class="n">development</span>;  <span class="c"># 以 development 配置启动 rails
</span>    
    <span class="c"># 默认为on，如果是在 virtualbox 上，改为 off，
</span>    <span class="c"># 否则文件在文件系统中被覆盖，nginx还是读出原来的文件内容
</span>    <span class="c"># 参考：https://stackoverflow.com/a/13116771
</span>    <span class="c"># 参考：https://forums.virtualbox.org/viewtopic.php?f=3&amp;t=33201
</span>    <span class="c"># 参考：https://www.cnblogs.com/zqifa/p/nginx-8.html
</span>    <span class="n">sendfile</span>        <span class="n">off</span>;

    <span class="n">server</span> {
      <span class="n">listen</span> <span class="m">2280</span>;
      <span class="n">server_name</span> <span class="n">localhost</span>;
      <span class="n">passenger_enabled</span> <span class="n">on</span>;
      <span class="n">client_max_body_size</span> <span class="m">50</span><span class="n">M</span>; <span class="c"># some upload files may be large
</span>      <span class="n">location</span> / {
        <span class="n">root</span>   /<span class="n">opt</span>/<span class="n">redmine342</span>/<span class="n">public</span>;
        <span class="n">index</span>  <span class="n">index</span>.<span class="n">html</span> <span class="n">index</span>.<span class="n">htm</span>;
      }
      ...
    }
...
}
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="passenger_app_env-development-设置运行环境为development">passenger_app_env development; 设置运行环境为development</h4>

<ul>
  <li>参考： <a href="https://stackoverflow.com/a/20845689/3316529">https://stackoverflow.com/a/20845689/3316529</a></li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="n">http</span> {
  <span class="n">passenger_root</span> /<span class="n">home</span>/<span class="n">user</span>/.<span class="n">rvm</span>/<span class="n">gems</span>/<span class="n">ruby</span>-<span class="m">2</span>.<span class="m">1</span>.<span class="m">0</span>@<span class="n">app</span>/<span class="n">gems</span>/<span class="n">passenger</span>-<span class="m">4</span>.<span class="m">0</span>.<span class="m">29</span>;
  <span class="n">passenger_ruby</span> /<span class="n">home</span>/<span class="n">user</span>/.<span class="n">rvm</span>/<span class="n">wrappers</span>/<span class="n">ruby</span>-<span class="m">2</span>.<span class="m">1</span>.<span class="m">0</span>@<span class="n">app</span>/<span class="n">ruby</span>;
  <span class="n">passenger_app_env</span> <span class="n">development</span>;
}
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="nginx-service">nginx service</h3>

<ol>
  <li>创建 /etc/init.d/nginx ，内容如下一小节</li>
  <li><code class="highlighter-rouge">rm -f /opt/nginx/logs/nginx.pid</code></li>
  <li><code class="highlighter-rouge">service nginx start</code></li>
</ol>

<h4 id="etcinitdnginx">/etc/init.d/nginx</h4>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169</pre></td><td class="code"><pre><span class="c">#!/bin/sh</span>
<span class="c">#</span>
<span class="c"># nginx        Startup script for nginx</span>
<span class="c">#</span>
<span class="c"># chkconfig: - 85 15</span>
<span class="c"># processname: nginx</span>
<span class="c"># config: /etc/nginx/nginx.conf</span>
<span class="c"># config: /etc/sysconfig/nginx</span>
<span class="c"># pidfile: /var/run/nginx.pid</span>
<span class="c"># description: nginx is an HTTP and reverse proxy server</span>
<span class="c">#</span>
<span class="c">### BEGIN INIT INFO</span>
<span class="c"># Provides: nginx</span>
<span class="c"># Required-Start: $local_fs $remote_fs $network</span>
<span class="c"># Required-Stop: $local_fs $remote_fs $network</span>
<span class="c"># Default-Start: 2 3 4 5</span>
<span class="c"># Default-Stop: 0 1 6</span>
<span class="c"># Short-Description: start and stop nginx</span>
<span class="c">### END INIT INFO</span>

<span class="c"># Source function library.</span>
. /etc/rc.d/init.d/functions

<span class="k">if</span> <span class="o">[</span> -L <span class="nv">$0</span> <span class="o">]</span>; <span class="k">then
    </span><span class="nv">initscript</span><span class="o">=</span><span class="sb">`</span>/bin/readlink -f <span class="nv">$0</span><span class="sb">`</span>
<span class="k">else
    </span><span class="nv">initscript</span><span class="o">=</span><span class="nv">$0</span>
<span class="k">fi

</span><span class="nv">sysconfig</span><span class="o">=</span><span class="sb">`</span>/bin/basename <span class="nv">$initscript</span><span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> -f /etc/sysconfig/<span class="nv">$sysconfig</span> <span class="o">]</span>; <span class="k">then</span>
    . /etc/sysconfig/<span class="nv">$sysconfig</span>
<span class="k">fi

</span><span class="nv">nginx</span><span class="o">=</span><span class="k">${</span><span class="nv">NGINX</span><span class="k">:-</span><span class="p">/opt/nginx/sbin/nginx</span><span class="k">}</span>
<span class="nv">prog</span><span class="o">=</span><span class="sb">`</span>/bin/basename <span class="nv">$nginx</span><span class="sb">`</span>
<span class="nv">conffile</span><span class="o">=</span><span class="k">${</span><span class="nv">CONFFILE</span><span class="k">:-</span><span class="p">/opt/nginx/conf/nginx.conf</span><span class="k">}</span>
<span class="nv">lockfile</span><span class="o">=</span><span class="k">${</span><span class="nv">LOCKFILE</span><span class="k">:-</span><span class="p">/var/lock/subsys/nginx</span><span class="k">}</span>
<span class="nv">pidfile</span><span class="o">=</span><span class="k">${</span><span class="nv">PIDFILE</span><span class="k">:-</span><span class="p">/opt/nginx/logs/nginx.pid</span><span class="k">}</span>
<span class="nv">SLEEPSEC</span><span class="o">=</span><span class="k">${</span><span class="nv">SLEEPSEC</span><span class="k">:-</span><span class="nv">1</span><span class="k">}</span>
<span class="nv">UPGRADEWAITLOOPS</span><span class="o">=</span><span class="k">${</span><span class="nv">UPGRADEWAITLOOPS</span><span class="k">:-</span><span class="nv">5</span><span class="k">}</span>
<span class="nv">CHECKSLEEP</span><span class="o">=</span><span class="k">${</span><span class="nv">CHECKSLEEP</span><span class="k">:-</span><span class="nv">3</span><span class="k">}</span>
<span class="nv">RETVAL</span><span class="o">=</span>0

start<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s2">$"Starting </span><span class="nv">$prog</span><span class="s2">: "</span>

    daemon --pidfile<span class="o">=</span><span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span> <span class="k">${</span><span class="nv">nginx</span><span class="k">}</span> -c <span class="k">${</span><span class="nv">conffile</span><span class="k">}</span>
    <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">echo</span>
    <span class="o">[</span> <span class="nv">$RETVAL</span> <span class="o">=</span> 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> touch <span class="k">${</span><span class="nv">lockfile</span><span class="k">}</span>
    <span class="k">return</span> <span class="nv">$RETVAL</span>
<span class="o">}</span>

stop<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s2">$"Stopping </span><span class="nv">$prog</span><span class="s2">: "</span>
    killproc -p <span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span> <span class="k">${</span><span class="nv">prog</span><span class="k">}</span>
    <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">echo</span>
    <span class="o">[</span> <span class="nv">$RETVAL</span> <span class="o">=</span> 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -f <span class="k">${</span><span class="nv">lockfile</span><span class="k">}</span> <span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span>
<span class="o">}</span>

reload<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s2">$"Reloading </span><span class="nv">$prog</span><span class="s2">: "</span>
    killproc -p <span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span> <span class="k">${</span><span class="nv">prog</span><span class="k">}</span> -HUP
    <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">echo</span>
<span class="o">}</span>

upgrade<span class="o">()</span> <span class="o">{</span>
    <span class="nv">oldbinpidfile</span><span class="o">=</span><span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span>.oldbin

    configtest -q <span class="o">||</span> <span class="k">return
    </span><span class="nb">echo</span> -n <span class="s2">$"Starting new master </span><span class="nv">$prog</span><span class="s2">: "</span>
    killproc -p <span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span> <span class="k">${</span><span class="nv">prog</span><span class="k">}</span> -USR2
    <span class="nb">echo

    </span><span class="k">for </span>i <span class="k">in</span> <span class="sb">`</span>/usr/bin/seq <span class="nv">$UPGRADEWAITLOOPS</span><span class="sb">`</span>; <span class="k">do</span>
        /bin/sleep <span class="nv">$SLEEPSEC</span>
        <span class="k">if</span> <span class="o">[</span> -f <span class="k">${</span><span class="nv">oldbinpidfile</span><span class="k">}</span> -a -f <span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span> <span class="o">]</span>; <span class="k">then
            </span><span class="nb">echo</span> -n <span class="s2">$"Graceful shutdown of old </span><span class="nv">$prog</span><span class="s2">: "</span>
            killproc -p <span class="k">${</span><span class="nv">oldbinpidfile</span><span class="k">}</span> <span class="k">${</span><span class="nv">prog</span><span class="k">}</span> -QUIT
            <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
            <span class="nb">echo
            </span><span class="k">return
        fi
    done

    </span><span class="nb">echo</span> <span class="s2">$"Upgrade failed!"</span>
    <span class="nv">RETVAL</span><span class="o">=</span>1
<span class="o">}</span>

configtest<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> -ne 0 <span class="o">]</span> ; <span class="k">then
        case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in</span>
            -q<span class="p">)</span>
                <span class="nv">FLAG</span><span class="o">=</span><span class="nv">$1</span>
                <span class="p">;;</span>
            <span class="k">*</span><span class="p">)</span>
                <span class="p">;;</span>
        <span class="k">esac</span>
        <span class="nb">shift
    </span><span class="k">fi</span>
    <span class="k">${</span><span class="nv">nginx</span><span class="k">}</span> -t -c <span class="k">${</span><span class="nv">conffile</span><span class="k">}</span> <span class="nv">$FLAG</span>
    <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
    <span class="k">return</span> <span class="nv">$RETVAL</span>
<span class="o">}</span>

rh_status<span class="o">()</span> <span class="o">{</span>
    status -p <span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span> -b <span class="k">${</span><span class="nv">nginx</span><span class="k">}</span> <span class="k">${</span><span class="nv">nginx</span><span class="k">}</span>
<span class="o">}</span>

check_reload<span class="o">()</span> <span class="o">{</span>
    <span class="nv">templog</span><span class="o">=</span><span class="sb">`</span>/bin/mktemp --tmpdir nginx-check-reload-XXXXXX.log<span class="sb">`</span>
    <span class="nb">trap</span> <span class="s1">'/bin/rm -f $templog'</span> 0
    /usr/bin/tail --pid<span class="o">=</span><span class="nv">$$</span> -n 0 --follow<span class="o">=</span>name /var/log/nginx/error.log &gt; <span class="nv">$templog</span> &amp;
    /bin/sleep 1
    /bin/echo -n <span class="s2">$"Sending reload signal to </span><span class="nv">$prog</span><span class="s2">: "</span>
    killproc -p <span class="k">${</span><span class="nv">pidfile</span><span class="k">}</span> <span class="k">${</span><span class="nv">prog</span><span class="k">}</span> -HUP
    /bin/echo
    /bin/sleep <span class="nv">$CHECKSLEEP</span>
    /bin/grep -E <span class="s2">"</span><span class="se">\[</span><span class="s2">emerg</span><span class="se">\]</span><span class="s2">|</span><span class="se">\[</span><span class="s2">alert</span><span class="se">\]</span><span class="s2">"</span> <span class="nv">$templog</span>
<span class="o">}</span>

<span class="c"># See how we were called.</span>
<span class="k">case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="k">in
    </span>start<span class="p">)</span>
        rh_status &gt;/dev/null 2&gt;&amp;1 <span class="o">&amp;&amp;</span> <span class="nb">exit </span>0
        start
        <span class="p">;;</span>
    stop<span class="p">)</span>
        stop
        <span class="p">;;</span>
    status<span class="p">)</span>
        rh_status
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
        <span class="p">;;</span>
    restart<span class="p">)</span>
        configtest -q <span class="o">||</span> <span class="nb">exit</span> <span class="nv">$RETVAL</span>
        stop
        start
        <span class="p">;;</span>
    upgrade<span class="p">)</span>
        rh_status &gt;/dev/null 2&gt;&amp;1 <span class="o">||</span> <span class="nb">exit </span>0
        upgrade
        <span class="p">;;</span>
    condrestart|try-restart<span class="p">)</span>
        <span class="k">if </span>rh_status &gt;/dev/null 2&gt;&amp;1; <span class="k">then
            </span>stop
            start
        <span class="k">fi</span>
        <span class="p">;;</span>
    force-reload|reload<span class="p">)</span>
        reload
        <span class="p">;;</span>
    configtest<span class="p">)</span>
        configtest
        <span class="p">;;</span>
    check-reload<span class="p">)</span>
        check_reload
        <span class="nv">RETVAL</span><span class="o">=</span>0
        <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>
        <span class="nb">echo</span> <span class="s2">$"Usage: </span><span class="nv">$prog</span><span class="s2"> {start|stop|restart|condrestart|try-restart|force-reload|upgrade|reload|status|help|configtest|check-reload}"</span>
        <span class="nv">RETVAL</span><span class="o">=</span>2
<span class="k">esac

</span><span class="nb">exit</span> <span class="nv">$RETVAL</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="iptables">iptables</h3>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre>iptables -L --line-numbers -n
# reject all rule 的序号，例如，5，accept rule 要插入在它之前。
iptables -I INPUT 5 -p tcp --dport 2280 -j ACCEPT
service iptables save
service iptables restart
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="nginx-自启动">nginx 自启动</h3>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre>chkconfig --add nginx
chkconfig --list nginx
</pre></td></tr></tbody></table>
</div>
</div>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags#ruby" title="Pages tagged ruby" class="tag"><span class="term">ruby</span></a><a href="/tags#rails" title="Pages tagged rails" class="tag"><span class="term">rails</span></a><a href="/tags#nginx" title="Pages tagged nginx" class="tag"><span class="term">nginx</span></a><a href="/tags#passenger" title="Pages tagged passenger" class="tag"><span class="term">passenger</span></a><a href="/tags#redmine" title="Pages tagged redmine" class="tag"><span class="term">redmine</span></a></span>
        
        
      </footer>
    </div><!-- /.entry-content -->
    
    
    
  </article>
</div><!-- /#main -->
</div><!-- post container -->














<script type="text/javascript">
  // embeded-iframe
  $(window).load(function(){
    $('.embeded-iframe').each(function(){
      $(this).height($(this).contents().find('html').height());
    });
  });
</script>





<div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2023 wi. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://github.com/aron-bordin/neo-hpstr-jekyll-theme" rel="nofollow">Neo-HPSTR Theme</a>.</span>

<script src="/assets/js/main.js?20230725301728281823445"></script>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
