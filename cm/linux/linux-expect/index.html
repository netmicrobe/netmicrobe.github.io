<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>expect脚本编写 &#8211; wi's Tech Blog</title>
<meta name="description" content="notes, articles, or reproduced">
<meta name="keywords" content="tcl, expect, ssh">



<!-- Open Graph -->
<meta property="og:locale" content="zh_CN">
<meta property="og:type" content="article">
<meta property="og:title" content="expect脚本编写">
<meta property="og:description" content="notes, articles, or reproduced">
<meta property="og:url" content="/cm/linux/linux-expect/">
<meta property="og:site_name" content="wi's Tech Blog">
<meta property="og:image" content="/images/images/avatar.png">





<link rel="canonical" href="/cm/linux/linux-expect/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="wi's Tech Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->

<meta http-equiv="cleartype" content="on">

<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="/assets/js/scripts.min.js"></script>

<!-- table of content -->
<script type="text/javascript" src="/assets/js/vendor/toc.js"></script>


<!-- Load Modernizr -->
<script type="text/javascript" src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Mathjax Support -->
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body>

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><i class="fa fa-bars"></i></a></li>
      <li class="header-item-title">
        <a href="/">
          
            <img class="logo" src="/images/avatar.png" alt="wi's Tech Blog">
          
          <a href="/" class="title"> wi's Tech Blog</a>
        </a>
      </li>
      
        
        


        
            
                <li class="header-item "><a href="/favorites">fav</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/categories">Categories</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/tags">Tags</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/">Home</a></li>
            
        
      
      <li class="header-item"><a href="/search"><i class="fa fa-search"></i></a></li>
    </ul>
  </div>



<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="/"><h3>Home</h3></a></li>
      
    
      
        <li><a href="/tags"><h3>Tags</h3></a></li>
      
    
      
        <li><a href="/categories"><h3>Categories</h3></a>
          <ul>
            
              
                <li><a href="/categories/#UML">UML</a></li>
            
              
                <li><a href="/categories/#Windows">Windows</a></li>
            
              
                <li><a href="/categories/#adb">adb</a></li>
            
              
                <li><a href="/categories/#adt">adt</a></li>
            
              
                <li><a href="/categories/#android">android</a></li>
            
              
                <li><a href="/categories/#apache">apache</a></li>
            
              
                <li><a href="/categories/#apple">apple</a></li>
            
              
                <li><a href="/categories/#bat">bat</a></li>
            
              
                <li><a href="/categories/#blog">blog</a></li>
            
              
                <li><a href="/categories/#blog_sample">blog_sample</a></li>
            
              
                <li><a href="/categories/#browser">browser</a></li>
            
              
                <li><a href="/categories/#burpsuite">burpsuite</a></li>
            
              
                <li><a href="/categories/#centos">centos</a></li>
            
              
                <li><a href="/categories/#chrome">chrome</a></li>
            
              
                <li><a href="/categories/#cm">cm</a></li>
            
              
                <li><a href="/categories/#common">common</a></li>
            
              
                <li><a href="/categories/#css">css</a></li>
            
              
                <li><a href="/categories/#cygwin">cygwin</a></li>
            
              
                <li><a href="/categories/#database">database</a></li>
            
              
                <li><a href="/categories/#db">db</a></li>
            
              
                <li><a href="/categories/#dev">dev</a></li>
            
              
                <li><a href="/categories/#device">device</a></li>
            
              
                <li><a href="/categories/#diff">diff</a></li>
            
              
                <li><a href="/categories/#disk">disk</a></li>
            
              
                <li><a href="/categories/#diy">diy</a></li>
            
              
                <li><a href="/categories/#dns">dns</a></li>
            
              
                <li><a href="/categories/#doc">doc</a></li>
            
              
                <li><a href="/categories/#docker">docker</a></li>
            
              
                <li><a href="/categories/#efi">efi</a></li>
            
              
                <li><a href="/categories/#emacs">emacs</a></li>
            
              
                <li><a href="/categories/#email">email</a></li>
            
              
                <li><a href="/categories/#emulator">emulator</a></li>
            
              
                <li><a href="/categories/#english">english</a></li>
            
              
                <li><a href="/categories/#esxi">esxi</a></li>
            
              
                <li><a href="/categories/#excel">excel</a></li>
            
              
                <li><a href="/categories/#exsi">exsi</a></li>
            
              
                <li><a href="/categories/#favorites">favorites</a></li>
            
              
                <li><a href="/categories/#ftp">ftp</a></li>
            
              
                <li><a href="/categories/#game">game</a></li>
            
              
                <li><a href="/categories/#git">git</a></li>
            
              
                <li><a href="/categories/#gitlab">gitlab</a></li>
            
              
                <li><a href="/categories/#go">go</a></li>
            
              
                <li><a href="/categories/#golang">golang</a></li>
            
              
                <li><a href="/categories/#hardware">hardware</a></li>
            
              
                <li><a href="/categories/#ide">ide</a></li>
            
              
                <li><a href="/categories/#internet">internet</a></li>
            
              
                <li><a href="/categories/#java">java</a></li>
            
              
                <li><a href="/categories/#javascript">javascript</a></li>
            
              
                <li><a href="/categories/#jekyll">jekyll</a></li>
            
              
                <li><a href="/categories/#jenkins">jenkins</a></li>
            
              
                <li><a href="/categories/#jmeter">jmeter</a></li>
            
              
                <li><a href="/categories/#kate">kate</a></li>
            
              
                <li><a href="/categories/#kde">kde</a></li>
            
              
                <li><a href="/categories/#ldap">ldap</a></li>
            
              
                <li><a href="/categories/#learn">learn</a></li>
            
              
                <li><a href="/categories/#learning">learning</a></li>
            
              
                <li><a href="/categories/#links">links</a></li>
            
              
                <li><a href="/categories/#linux">linux</a></li>
            
              
                <li><a href="/categories/#living">living</a></li>
            
              
                <li><a href="/categories/#mac">mac</a></li>
            
              
                <li><a href="/categories/#mac-os">mac-os</a></li>
            
              
                <li><a href="/categories/#macos">macos</a></li>
            
              
                <li><a href="/categories/#mail">mail</a></li>
            
              
                <li><a href="/categories/#manjaro">manjaro</a></li>
            
              
                <li><a href="/categories/#markdown">markdown</a></li>
            
              
                <li><a href="/categories/#maven">maven</a></li>
            
              
                <li><a href="/categories/#memcached">memcached</a></li>
            
              
                <li><a href="/categories/#microsoft">microsoft</a></li>
            
              
                <li><a href="/categories/#moco">moco</a></li>
            
              
                <li><a href="/categories/#mysql">mysql</a></li>
            
              
                <li><a href="/categories/#nas">nas</a></li>
            
              
                <li><a href="/categories/#ndk">ndk</a></li>
            
              
                <li><a href="/categories/#netbean">netbean</a></li>
            
              
                <li><a href="/categories/#network">network</a></li>
            
              
                <li><a href="/categories/#netwrok">netwrok</a></li>
            
              
                <li><a href="/categories/#nginx">nginx</a></li>
            
              
                <li><a href="/categories/#nodejs">nodejs</a></li>
            
              
                <li><a href="/categories/#notepad++">notepad++</a></li>
            
              
                <li><a href="/categories/#office">office</a></li>
            
              
                <li><a href="/categories/#open-course">open-course</a></li>
            
              
                <li><a href="/categories/#openkm">openkm</a></li>
            
              
                <li><a href="/categories/#openwrt">openwrt</a></li>
            
              
                <li><a href="/categories/#outlook">outlook</a></li>
            
              
                <li><a href="/categories/#pdf">pdf</a></li>
            
              
                <li><a href="/categories/#perl">perl</a></li>
            
              
                <li><a href="/categories/#phone">phone</a></li>
            
              
                <li><a href="/categories/#php">php</a></li>
            
              
                <li><a href="/categories/#postgresql">postgresql</a></li>
            
              
                <li><a href="/categories/#product">product</a></li>
            
              
                <li><a href="/categories/#python">python</a></li>
            
              
                <li><a href="/categories/#rails">rails</a></li>
            
              
                <li><a href="/categories/#redmine">redmine</a></li>
            
              
                <li><a href="/categories/#regex">regex</a></li>
            
              
                <li><a href="/categories/#router">router</a></li>
            
              
                <li><a href="/categories/#ruby">ruby</a></li>
            
              
                <li><a href="/categories/#search-engine">search-engine</a></li>
            
              
                <li><a href="/categories/#security">security</a></li>
            
              
                <li><a href="/categories/#sed">sed</a></li>
            
              
                <li><a href="/categories/#ssh">ssh</a></li>
            
              
                <li><a href="/categories/#streaming">streaming</a></li>
            
              
                <li><a href="/categories/#study">study</a></li>
            
              
                <li><a href="/categories/#subversion">subversion</a></li>
            
              
                <li><a href="/categories/#tcpdump">tcpdump</a></li>
            
              
                <li><a href="/categories/#tech">tech</a></li>
            
              
                <li><a href="/categories/#testing">testing</a></li>
            
              
                <li><a href="/categories/#testlink">testlink</a></li>
            
              
                <li><a href="/categories/#text">text</a></li>
            
              
                <li><a href="/categories/#tomcat">tomcat</a></li>
            
              
                <li><a href="/categories/#ubuntu">ubuntu</a></li>
            
              
                <li><a href="/categories/#ufw">ufw</a></li>
            
              
                <li><a href="/categories/#vbs">vbs</a></li>
            
              
                <li><a href="/categories/#vim">vim</a></li>
            
              
                <li><a href="/categories/#virtual-box">virtual-box</a></li>
            
              
                <li><a href="/categories/#virtualbox">virtualbox</a></li>
            
              
                <li><a href="/categories/#virtualization">virtualization</a></li>
            
              
                <li><a href="/categories/#vm">vm</a></li>
            
              
                <li><a href="/categories/#vpn">vpn</a></li>
            
              
                <li><a href="/categories/#web">web</a></li>
            
              
                <li><a href="/categories/#windows">windows</a></li>
            
              
                <li><a href="/categories/#xampp">xampp</a></li>
            
              
                <li><a href="/categories/#收藏夹">收藏夹</a></li>
            
              
                <li><a href="/categories/#测试工具">测试工具</a></li>
            
              
                <li><a href="/categories/#玩机">玩机</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="/favorites"><h3>fav</h3></a></li>
      
    
  </ul>
</nav>




<div id="post" >
<div id="main" role="main" >
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">expect脚本编写</h1>
      
        <h3><span class="entry-date date published updated"><time datetime="2018-08-15T00:00:00+08:00">August 15, 2018</time></span></h3>
      
      
      
      
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 60);
  return false
})

$(".toc-button").on('click', function(){
  $(".toc").toggle();
});


$(window).click(function(evt){
  if( !evt.target.matches('.toc') 
      && !evt.target.matches('.toc>ul') 
      && !evt.target.matches('.toc-button') ) {
    $('.toc').each(function(){
      if( $(this).is(":visible") ) {
        $(this).hide();
      }
    });
  }
});

});
</script>

<div class="float-toc">
    <i class="toc-button fa fa-list-ol" aria-hidden="true"></i>
  <div id="toc"></div>
</div>

      
      
      <hr />
<ul>
  <li>参考：
    <ul>
      <li><a href="https://www.slashroot.in/expect-command-tutorial-linux-example-usage">Expect Command Tutorial in Linux With Example Usage</a></li>
      <li><a href="https://core.tcl.tk/expect/index">Expect</a></li>
      <li><a href="https://linux.die.net/man/1/expect">expect(1) - Linux man page</a></li>
      <li><a href="https://www.pantz.org/software/expect/expect_examples_and_tips.html">Expect examples and tips</a></li>
      <li><a href=""></a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="expect">expect</h2>

<h3 id="安装-expect">安装 expect</h3>

<p>For Red Hat based systems,</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>yum install expect
</pre></td></tr></tbody></table>
</div>
</div>

<p>或者, For Debian based or Ubuntu</p>

<div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>apt-get install expect
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="most-used-commands-and-descriptions">Most used commands and descriptions</h3>

<ul>
  <li>
    <p><code class="highlighter-rouge">expect</code></p>

    <p>The expect command will wait until one of the patterns given matches the output of a spawned process, a specified time period has passed, or an end-of-file is seen. Since you can give the expect command multiple things to match on you can have it do different things when it matches. The first sentence bares repeating, but I will try to expand on it. Expect will constantly loop through the multiple given patterns until a match is found. Expect will match the first pattern it finds in the order you specified them. When it finds a match it will execute any commands given and keep following any more nested commands until it hits the last command. It will never return to the calling block. It then moves onto the next part of the script.</p>

    <p>If at any time there are no matches it will timeout. If the pattern keyword (match word) “timeout” is used you can have it perform an action when the timeout happens.</p>

    <p>If an eof is returned it will exit the spawned process and move on. If you use “eof” as a pattern keyword then you can have it also perform an action if an eof happens.</p>

    <p>You can also use the pattern keyword called “default” that can perform an action if either eof or timeout are reached. We will see how to use this to make great error messages later.</p>
  </li>
  <li><code class="highlighter-rouge">send</code><br />
Sends string to the current process. Usually this is a command followed by a return character (\r) like send “yourpassword\r”. You use the expect command to match the output and decide what to send the current process.</li>
  <li><code class="highlighter-rouge">spawn</code> - Creates a new process by running a given program. This is usually given at the start of the script to begin the process. Examples given earlier were “spawn ssh user@host or spawn ftp host”. You are starting up (connecting to) the process you want to interact with.</li>
  <li><code class="highlighter-rouge">send_user</code> - Output that gets sent to stdout. This is used for sending message to the screen as the script runs. It is great for user feedback, banners, and for generating error messages.</li>
  <li><code class="highlighter-rouge">interact</code> - This will give control of the current process over to the user for interaction. Great if the script can get a person to a certain point and then they have to take over. When you get to the point you want to interact with just put in the word “interact”.</li>
  <li><code class="highlighter-rouge">log_user</code> - By default all process output shows up on stdout (your screen). To stop this you can set log_user to 0 “log_user 0” at the top of your script. To turn things back on just set it back to “log_user 1” or remove the line.</li>
  <li><code class="highlighter-rouge">exp_internal</code> - This is essentially the Expect debug log mode. Turn this on by setting this to 1 like “exp_internal 1”. It will show you everything expect sees and how it is trying to match it. This is invaluable for when you think your script should be working, but it is not.</li>
  <li><code class="highlighter-rouge">set</code> - Set is just how to set variables in Tcl and thus Expect. Things like setting the global timeout value from 10 seconds to 20 with “set timeout 20”. Another would be grabbing a username from the command line of the expect script and setting it to a variable “set username [lindex $argv 0]”.</li>
  <li><code class="highlighter-rouge">close</code> - Closes the connection to the current process.</li>
</ul>

<h3 id="简单的例子">简单的例子</h3>

<ul>
  <li>interactive_program.sh</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">"What is your name?"</span>
<span class="nb">read </span>ANSWER
<span class="nb">echo</span> <span class="s2">"How many dogs you have?"</span>
<span class="nb">read </span>ANSWER
<span class="nb">echo</span> <span class="s2">"How many cats you have?"</span>
<span class="nb">read </span>ANSWER
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>expect_script.sh</li>
</ul>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/expect</span>
spawn ./interactive_program.sh
expect -exact <span class="s2">"What is your name?</span><span class="se">\r</span><span class="s2">"</span>
send -- <span class="s2">"Sam</span><span class="se">\r</span><span class="s2">"</span>
expect -exact <span class="s2">"How many dogs you have?</span><span class="se">\r</span><span class="s2">"</span>
send -- <span class="s2">"2</span><span class="se">\r</span><span class="s2">"</span>
expect -exact <span class="s2">"How many cats you have?</span><span class="se">\r</span><span class="s2">"</span>
send -- <span class="s2">"2</span><span class="se">\r</span><span class="s2">"</span>
expect eof
</pre></td></tr></tbody></table>
</div>
</div>

<p><code class="highlighter-rouge">expect eof</code> indicates that the script ends here.</p>

<h3 id="带参数的例子">带参数的例子</h3>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/expect</span>
<span class="k">set</span> user_name <span class="p">[</span><span class="nb">lindex</span> <span class="nv">$argv</span> 0<span class="p">]</span>
<span class="k">set</span> pass_word <span class="p">[</span><span class="nb">lindex</span> <span class="nv">$argv</span> 1<span class="p">]</span>
spawn passwd <span class="nv">$user</span>_name
expect -exact <span class="s2">"Enter new UNIX password: "</span>
send -- <span class="s2">"</span><span class="nv">$pass</span><span class="s2">_word</span><span class="se">\r</span><span class="s2">"</span>
expect -exact <span class="s2">"</span><span class="se">\r</span><span class="s2">Retype new UNIX password: "</span>
send -- <span class="s2">"</span><span class="nv">$pass</span><span class="s2">_word</span><span class="se">\r</span><span class="s2">"</span>
expect eof
</pre></td></tr></tbody></table>
</div>
</div>

<p><code class="highlighter-rouge">set user_name [lindex $argv 0]</code> &amp; <code class="highlighter-rouge">set pass_word [lindex $argv 1]</code> creates two variables named <code class="highlighter-rouge">user_name</code> and <code class="highlighter-rouge">pass_word</code> from the command line parameters provided</p>

<h3 id="脚本中使用循环">脚本中使用循环</h3>

<h4 id="foreach-loop">foreach loop</h4>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/expect</span>
<span class="k">set</span> l <span class="p">[</span><span class="nb">list</span> testuser testuser1 testuser2 testuser3<span class="p">]</span>
<span class="k">set</span> pass_word sf345234
<span class="k">foreach</span> user_name <span class="nv">$l</span> <span class="p">{</span>
    spawn passwd <span class="nv">$user</span>_name
    expect -exact <span class="s2">"Enter new UNIX password: "</span>
    send -- <span class="s2">"</span><span class="nv">$pass</span><span class="s2">_word</span><span class="se">\r</span><span class="s2">"</span>
    expect -exact <span class="s2">"</span><span class="se">\r</span><span class="s2">Retype new UNIX password: "</span>
    send -- <span class="s2">"</span><span class="nv">$pass</span><span class="s2">_word</span><span class="se">\r</span><span class="s2">"</span>
    expect eof
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<ul>
  <li>note: the fact that the above script assumes that the users testuser, testuser1, testuser2 and testuser3 exists in the system.</li>
</ul>

<h4 id="for-loop">for loop</h4>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/expect -f</span>

<span class="k">for</span> <span class="p">{</span><span class="k">set</span> NUM 0<span class="p">}</span> <span class="p">{</span>$NUM &lt;= 5<span class="p">}</span> <span class="p">{</span><span class="nb">incr</span> NUM<span class="p">}</span> <span class="p">{</span>
  puts <span class="s2">"</span><span class="se">\n</span><span class="s2">NUM = </span>$<span class="s2">NUM"</span>
<span class="p">}</span>
<span class="nb">puts</span> <span class="s2">""</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="while-loop">while loop</h4>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/expect</span>
<span class="k">set</span> pass_word sf345234
<span class="k">set</span> m 0
<span class="k">while</span> <span class="p">{</span><span class="nv">$m</span>&lt;10<span class="p">}</span> <span class="p">{</span>
    spawn passwd <span class="s2">"testuser</span><span class="nv">$m</span><span class="s2">"</span>
    expect -exact <span class="s2">"Enter new UNIX password: "</span>
    send -- <span class="s2">"</span><span class="nv">$pass</span><span class="s2">_word</span><span class="se">\r</span><span class="s2">"</span>
    expect -exact <span class="s2">"</span><span class="se">\r</span><span class="s2">Retype new UNIX password: "</span>
    send -- <span class="s2">"</span><span class="nv">$pass</span><span class="s2">_word</span><span class="se">\r</span><span class="s2">"</span>
    expect eof
        incr m
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="条件控制-if">条件控制 if</h3>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/expect</span>
<span class="k">set</span> m 0
<span class="k">while</span> <span class="p">{</span><span class="nv">$m</span>&lt;10<span class="p">}</span> <span class="p">{</span>
    set pass_word sf345234
    if <span class="p">{</span> <span class="nv">$m</span> == 2 <span class="p">}</span> <span class="p">{</span>
      set pass_word asfjhfajhakasfa234
    <span class="p">}</span>
    spawn passwd <span class="s2">"testuser</span><span class="nv">$m</span><span class="s2">"</span>
    expect -exact <span class="s2">"Enter new UNIX password: "</span>
    send -- <span class="s2">"</span><span class="nv">$pass</span><span class="s2">_word</span><span class="se">\r</span><span class="s2">"</span>
    expect -exact <span class="s2">"</span><span class="se">\r</span><span class="s2">Retype new UNIX password: "</span>
    send -- <span class="s2">"</span><span class="nv">$pass</span><span class="s2">_word</span><span class="se">\r</span><span class="s2">"</span>
    expect eof
    incr m
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/expect -f</span>
 
set NUM 1

<span class="k">if</span> <span class="p">{</span> $NUM &lt; 5 <span class="p">}</span> <span class="p">{</span>
  puts <span class="s2">"</span><span class="se">\S</span><span class="s2">maller than 5</span><span class="se">\n</span><span class="s2">"</span>
<span class="p">}</span> <span class="k">else</span>if <span class="p">{</span> $NUM &gt; 5 <span class="p">}</span> <span class="p">{</span>
  puts <span class="s2">"</span><span class="se">\B</span><span class="s2">igger than 5</span><span class="se">\n</span><span class="s2">"</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  puts <span class="s2">"</span><span class="se">\E</span><span class="s2">quals 5</span><span class="se">\n</span><span class="s2">"</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h4 id="user-defined-functions">User-defined Functions</h4>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="k">proc</span> myfunc <span class="p">{</span> TOTAL <span class="p">}</span> <span class="p">{</span>
  set TOTAL <span class="p">[</span><span class="k">expr</span> $TOTAL + 1<span class="p">]</span>
  return <span class="s2">"</span>$<span class="s2">TOTAL"</span>
<span class="p">}</span>

<span class="k">set</span> NUM 0
<span class="k">while</span> <span class="p">{</span>$NUM &lt;= 5<span class="p">}</span> <span class="p">{</span>
  puts <span class="s2">"</span><span class="se">\n</span><span class="s2">Number </span>$<span class="s2">NUM"</span>
  set NUM <span class="p">[</span>myfunc $NUM<span class="p">]</span>
<span class="p">}</span>

<span class="nb">puts</span> <span class="s2">""</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="ssh-自动登录的例子">ssh 自动登录的例子</h3>

<div class="language-tcl highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><pre><span class="c1">#!/usr/bin/expect</span>
<span class="c1">#Usage ssh-pass &lt;host&gt; &lt;ssh user&gt; &lt;ssh password&gt;</span>

<span class="k">set</span> timeout 60
<span class="k">set</span> username <span class="p">[</span><span class="nb">lindex</span> <span class="nv">$argv</span> 1<span class="p">]</span>
<span class="k">set</span> password <span class="p">[</span><span class="nb">lindex</span> <span class="nv">$argv</span> 2<span class="p">]</span>
<span class="k">set</span> hostname <span class="p">[</span><span class="nb">lindex</span> <span class="nv">$argv</span> 0<span class="p">]</span>
<span class="c1">#log_user 0</span>

<span class="k">if</span> <span class="p">{[</span><span class="nb">llength</span> <span class="nv">$argv</span><span class="p">]</span> == 0<span class="p">}</span> <span class="p">{</span>
  send_user <span class="s2">"Usage: ssh-pass hostname username </span><span class="se">\'</span><span class="s2">password</span><span class="se">\'\n</span><span class="s2">"</span>
  exit 1
<span class="p">}</span>

send_user <span class="s2">"</span><span class="se">\n</span><span class="s2">#####</span><span class="se">\n</span><span class="s2"># </span><span class="nv">$hostname</span><span class="se">\n</span><span class="s2">#####</span><span class="se">\n</span><span class="s2">"</span>

spawn ssh -q -oStrictHostKeyChecking=no -oCheckHostIP=no <span class="nv">$username</span>@$hostname

expect <span class="p">{</span>
  timeout <span class="p">{</span> send_user <span class="s2">"</span><span class="se">\n</span><span class="s2">Failed to get password prompt</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> exit 1 <span class="p">}</span>
  eof <span class="p">{</span> send_user <span class="s2">"</span><span class="se">\n</span><span class="s2">SSH failure for </span><span class="nv">$hostname</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span> exit 1 <span class="p">}</span>
  <span class="s2">"*?assword"</span>
<span class="p">}</span>

send <span class="s2">"</span><span class="nv">$password</span><span class="se">\r</span><span class="s2">"</span>

interact
</pre></td></tr></tbody></table>
</div>
</div>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags#tcl" title="Pages tagged tcl" class="tag"><span class="term">tcl</span></a><a href="/tags#expect" title="Pages tagged expect" class="tag"><span class="term">expect</span></a><a href="/tags#ssh" title="Pages tagged ssh" class="tag"><span class="term">ssh</span></a></span>
        
        
      </footer>
    </div><!-- /.entry-content -->
    
    
    
  </article>
</div><!-- /#main -->
</div><!-- post container -->














<script type="text/javascript">
  // embeded-iframe
  $(window).load(function(){
    $('.embeded-iframe').each(function(){
      $(this).height($(this).contents().find('html').height());
    });
  });
</script>





<div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2023 wi. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://github.com/aron-bordin/neo-hpstr-jekyll-theme" rel="nofollow">Neo-HPSTR Theme</a>.</span>

<script src="/assets/js/main.js?20230725301728281823445"></script>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
