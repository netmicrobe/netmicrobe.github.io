<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>CentOS 7 上使用 KVM，关联 virtualize &#8211; wi's Tech Blog</title>
<meta name="description" content="notes, articles, or reproduced">
<meta name="keywords" content="">



<!-- Open Graph -->
<meta property="og:locale" content="zh_CN">
<meta property="og:type" content="article">
<meta property="og:title" content="CentOS 7 上使用 KVM，关联 virtualize">
<meta property="og:description" content="notes, articles, or reproduced">
<meta property="og:url" content="/kvm-host-centos7/">
<meta property="og:site_name" content="wi's Tech Blog">
<meta property="og:image" content="/images/images/avatar.png">





<link rel="canonical" href="/kvm-host-centos7/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="wi's Tech Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->

<meta http-equiv="cleartype" content="on">

<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="/assets/js/scripts.min.js"></script>

<!-- table of content -->
<script type="text/javascript" src="/assets/js/vendor/toc.js"></script>


<!-- Load Modernizr -->
<script type="text/javascript" src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Mathjax Support -->
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body>

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><i class="fa fa-bars"></i></a></li>
      <li class="header-item-title">
        <a href="/">
          
            <img class="logo" src="/images/avatar.png" alt="wi's Tech Blog">
          
          <a href="/" class="title"> wi's Tech Blog</a>
        </a>
      </li>
      
        
        


        
            
                <li class="header-item "><a href="/favorites">fav</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/categories">Categories</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/tags">Tags</a></li>
            
        
      
        
        


        
            
                <li class="header-item "><a href="/">Home</a></li>
            
        
      
      <li class="header-item"><a href="/search"><i class="fa fa-search"></i></a></li>
    </ul>
  </div>



<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="/"><h3>Home</h3></a></li>
      
    
      
        <li><a href="/tags"><h3>Tags</h3></a></li>
      
    
      
        <li><a href="/categories"><h3>Categories</h3></a>
          <ul>
            
              
                <li><a href="/categories/#UML">UML</a></li>
            
              
                <li><a href="/categories/#Windows">Windows</a></li>
            
              
                <li><a href="/categories/#adb">adb</a></li>
            
              
                <li><a href="/categories/#adt">adt</a></li>
            
              
                <li><a href="/categories/#android">android</a></li>
            
              
                <li><a href="/categories/#apache">apache</a></li>
            
              
                <li><a href="/categories/#apple">apple</a></li>
            
              
                <li><a href="/categories/#bat">bat</a></li>
            
              
                <li><a href="/categories/#blog">blog</a></li>
            
              
                <li><a href="/categories/#blog_sample">blog_sample</a></li>
            
              
                <li><a href="/categories/#browser">browser</a></li>
            
              
                <li><a href="/categories/#burpsuite">burpsuite</a></li>
            
              
                <li><a href="/categories/#centos">centos</a></li>
            
              
                <li><a href="/categories/#chrome">chrome</a></li>
            
              
                <li><a href="/categories/#cm">cm</a></li>
            
              
                <li><a href="/categories/#common">common</a></li>
            
              
                <li><a href="/categories/#css">css</a></li>
            
              
                <li><a href="/categories/#cygwin">cygwin</a></li>
            
              
                <li><a href="/categories/#database">database</a></li>
            
              
                <li><a href="/categories/#db">db</a></li>
            
              
                <li><a href="/categories/#dev">dev</a></li>
            
              
                <li><a href="/categories/#device">device</a></li>
            
              
                <li><a href="/categories/#diff">diff</a></li>
            
              
                <li><a href="/categories/#disk">disk</a></li>
            
              
                <li><a href="/categories/#diy">diy</a></li>
            
              
                <li><a href="/categories/#dns">dns</a></li>
            
              
                <li><a href="/categories/#doc">doc</a></li>
            
              
                <li><a href="/categories/#docker">docker</a></li>
            
              
                <li><a href="/categories/#efi">efi</a></li>
            
              
                <li><a href="/categories/#emacs">emacs</a></li>
            
              
                <li><a href="/categories/#email">email</a></li>
            
              
                <li><a href="/categories/#emulator">emulator</a></li>
            
              
                <li><a href="/categories/#english">english</a></li>
            
              
                <li><a href="/categories/#esxi">esxi</a></li>
            
              
                <li><a href="/categories/#excel">excel</a></li>
            
              
                <li><a href="/categories/#exsi">exsi</a></li>
            
              
                <li><a href="/categories/#favorites">favorites</a></li>
            
              
                <li><a href="/categories/#ftp">ftp</a></li>
            
              
                <li><a href="/categories/#game">game</a></li>
            
              
                <li><a href="/categories/#git">git</a></li>
            
              
                <li><a href="/categories/#gitlab">gitlab</a></li>
            
              
                <li><a href="/categories/#go">go</a></li>
            
              
                <li><a href="/categories/#golang">golang</a></li>
            
              
                <li><a href="/categories/#hardware">hardware</a></li>
            
              
                <li><a href="/categories/#ide">ide</a></li>
            
              
                <li><a href="/categories/#internet">internet</a></li>
            
              
                <li><a href="/categories/#java">java</a></li>
            
              
                <li><a href="/categories/#javascript">javascript</a></li>
            
              
                <li><a href="/categories/#jekyll">jekyll</a></li>
            
              
                <li><a href="/categories/#jenkins">jenkins</a></li>
            
              
                <li><a href="/categories/#jmeter">jmeter</a></li>
            
              
                <li><a href="/categories/#kate">kate</a></li>
            
              
                <li><a href="/categories/#kde">kde</a></li>
            
              
                <li><a href="/categories/#ldap">ldap</a></li>
            
              
                <li><a href="/categories/#learn">learn</a></li>
            
              
                <li><a href="/categories/#learning">learning</a></li>
            
              
                <li><a href="/categories/#links">links</a></li>
            
              
                <li><a href="/categories/#linux">linux</a></li>
            
              
                <li><a href="/categories/#living">living</a></li>
            
              
                <li><a href="/categories/#mac">mac</a></li>
            
              
                <li><a href="/categories/#mac-os">mac-os</a></li>
            
              
                <li><a href="/categories/#macos">macos</a></li>
            
              
                <li><a href="/categories/#mail">mail</a></li>
            
              
                <li><a href="/categories/#manjaro">manjaro</a></li>
            
              
                <li><a href="/categories/#markdown">markdown</a></li>
            
              
                <li><a href="/categories/#maven">maven</a></li>
            
              
                <li><a href="/categories/#memcached">memcached</a></li>
            
              
                <li><a href="/categories/#microsoft">microsoft</a></li>
            
              
                <li><a href="/categories/#moco">moco</a></li>
            
              
                <li><a href="/categories/#mysql">mysql</a></li>
            
              
                <li><a href="/categories/#nas">nas</a></li>
            
              
                <li><a href="/categories/#ndk">ndk</a></li>
            
              
                <li><a href="/categories/#netbean">netbean</a></li>
            
              
                <li><a href="/categories/#network">network</a></li>
            
              
                <li><a href="/categories/#netwrok">netwrok</a></li>
            
              
                <li><a href="/categories/#nginx">nginx</a></li>
            
              
                <li><a href="/categories/#nodejs">nodejs</a></li>
            
              
                <li><a href="/categories/#notepad++">notepad++</a></li>
            
              
                <li><a href="/categories/#office">office</a></li>
            
              
                <li><a href="/categories/#open-course">open-course</a></li>
            
              
                <li><a href="/categories/#openkm">openkm</a></li>
            
              
                <li><a href="/categories/#openwrt">openwrt</a></li>
            
              
                <li><a href="/categories/#outlook">outlook</a></li>
            
              
                <li><a href="/categories/#pdf">pdf</a></li>
            
              
                <li><a href="/categories/#perl">perl</a></li>
            
              
                <li><a href="/categories/#phone">phone</a></li>
            
              
                <li><a href="/categories/#php">php</a></li>
            
              
                <li><a href="/categories/#postgresql">postgresql</a></li>
            
              
                <li><a href="/categories/#product">product</a></li>
            
              
                <li><a href="/categories/#python">python</a></li>
            
              
                <li><a href="/categories/#rails">rails</a></li>
            
              
                <li><a href="/categories/#redmine">redmine</a></li>
            
              
                <li><a href="/categories/#regex">regex</a></li>
            
              
                <li><a href="/categories/#router">router</a></li>
            
              
                <li><a href="/categories/#ruby">ruby</a></li>
            
              
                <li><a href="/categories/#search-engine">search-engine</a></li>
            
              
                <li><a href="/categories/#security">security</a></li>
            
              
                <li><a href="/categories/#sed">sed</a></li>
            
              
                <li><a href="/categories/#ssh">ssh</a></li>
            
              
                <li><a href="/categories/#streaming">streaming</a></li>
            
              
                <li><a href="/categories/#study">study</a></li>
            
              
                <li><a href="/categories/#subversion">subversion</a></li>
            
              
                <li><a href="/categories/#tcpdump">tcpdump</a></li>
            
              
                <li><a href="/categories/#tech">tech</a></li>
            
              
                <li><a href="/categories/#testing">testing</a></li>
            
              
                <li><a href="/categories/#testlink">testlink</a></li>
            
              
                <li><a href="/categories/#text">text</a></li>
            
              
                <li><a href="/categories/#tomcat">tomcat</a></li>
            
              
                <li><a href="/categories/#ubuntu">ubuntu</a></li>
            
              
                <li><a href="/categories/#ufw">ufw</a></li>
            
              
                <li><a href="/categories/#vbs">vbs</a></li>
            
              
                <li><a href="/categories/#vim">vim</a></li>
            
              
                <li><a href="/categories/#virtual-box">virtual-box</a></li>
            
              
                <li><a href="/categories/#virtualbox">virtualbox</a></li>
            
              
                <li><a href="/categories/#virtualization">virtualization</a></li>
            
              
                <li><a href="/categories/#vm">vm</a></li>
            
              
                <li><a href="/categories/#vpn">vpn</a></li>
            
              
                <li><a href="/categories/#web">web</a></li>
            
              
                <li><a href="/categories/#windows">windows</a></li>
            
              
                <li><a href="/categories/#xampp">xampp</a></li>
            
              
                <li><a href="/categories/#收藏夹">收藏夹</a></li>
            
              
                <li><a href="/categories/#测试工具">测试工具</a></li>
            
              
                <li><a href="/categories/#玩机">玩机</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="/favorites"><h3>fav</h3></a></li>
      
    
  </ul>
</nav>




<div id="post" >
<div id="main" role="main" >
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">CentOS 7 上使用 KVM，关联 virtualize</h1>
      
        <h3><span class="entry-date date published updated"><time datetime="2023-02-14T00:00:00+08:00">February 14, 2023</time></span></h3>
      
      
      
      
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 60);
  return false
})

$(".toc-button").on('click', function(){
  $(".toc").toggle();
});


$(window).click(function(evt){
  if( !evt.target.matches('.toc') 
      && !evt.target.matches('.toc>ul') 
      && !evt.target.matches('.toc-button') ) {
    $('.toc').each(function(){
      if( $(this).is(":visible") ) {
        $(this).hide();
      }
    });
  }
});

});
</script>

<div class="float-toc">
    <i class="toc-button fa fa-list-ol" aria-hidden="true"></i>
  <div id="toc"></div>
</div>

      
      
      <ul>
  <li>参考
    <ul>
      <li><a href="https://www.cyberciti.biz/faq/how-to-install-kvm-on-centos-7-rhel-7-headless-server/">How to install KVM on CentOS 7 / RHEL 7 Headless Server</a></li>
      <li><a href="https://joshrosso.com/c/linux-hypervisor-setup/">Linux Hypervisor Setup (libvirt/qemu/kvm)</a></li>
      <li><a href="https://www.dwarmstrong.org/kvm-qemu-libvirt/">Virtualization using KVM + QEMU + libvirt</a></li>
      <li><a href="https://blog.wikichoon.com/2016/01/qemusystem-vs-qemusession.html">qemu:///system vs qemu:///session</a></li>
      <li><a href="https://raphtlw.medium.com/how-to-set-up-a-kvm-qemu-windows-10-vm-ca1789411760">Install Windows 10 on Pop!OS - Raphael</a></li>
      <li><a href="https://pve.proxmox.com/wiki/Performance_Tweaks">Performance Tweaks</a></li>
      <li><a href="https://getlabsdone.com/10-easy-steps-to-install-windows-10-on-linux-kvm/">10 Easy Steps To Install Windows 10 on Linux KVM – KVM Windows</a></li>
      <li>
        <table>
          <tbody>
            <tr>
              <td>[Solution</td>
              <td>How To Extend Windows Storage in KVM ?](https://getlabsdone.com/how-to-extend-windows-storage-in-kvm/)</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li><a href="https://documentation.suse.com/zh-cn/sles/15-SP1/html/SLES-all/article-vt-best-practices.html">Virtualization Best Practices</a><br />
  虽说是suse的文档，道理是相通的。</li>
      <li><a href=""></a></li>
      <li><a href=""></a></li>
    </ul>
  </li>
</ul>

<ol>
  <li>
    <p>检查是否支持虚拟化，不支持的话，重启去BIOS里面设置下</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre> lscpu | grep Virtualization

 Virtualization: VT-x
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>安装 KVM</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre> yum install qemu-kvm libvirt libvirt-python libguestfs-tools virt-install
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>Start the libvirtd service:</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre> systemctl <span class="nb">enable </span>libvirtd
 systemctl start libvirtd
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>Verify kvm installation</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre> <span class="c"># Make sure KVM module loaded</span>
 lsmod | grep -i kvm
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>权限设置<br />
 这一步在centos上使用root倒不需要，在 debian 系上用的。</p>

    <ol>
      <li>添加用户到 <code class="highlighter-rouge">kvm</code> 和 <code class="highlighter-rouge">libvirt</code> 用户组
        <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre> sudo adduser foo kvm
 sudo adduser foo libvirt
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>libvirt.conf
        <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre> <span class="nv">$ </span>mkdir ~/.config/libvirt
 <span class="nv">$ </span>sudo cp -rv /etc/libvirt/libvirt.conf ~/.config/libvirt/
 <span class="nv">$ </span>sudo chown foo: ~/.config/libvirt/libvirt.conf
</pre></td></tr></tbody></table>
</div>
        </div>

        <p>修改 libvirt.conf</p>
        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre> uri_default = "qemu:///system"
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>
        <p>qemu.conf</p>

        <p>修改 <code class="highlighter-rouge">/etc/libvirt/qemu.conf</code>， 设置 <code class="highlighter-rouge">user</code> 为自己，<code class="highlighter-rouge">group</code> 为 <code class="highlighter-rouge">libvirt</code></p>
        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre> user = "foo"
 group = "libvirt"
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
      <li>重启 <code class="highlighter-rouge">libvirt</code> 服务
        <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre> sudo systemctl start libvirtd
</pre></td></tr></tbody></table>
</div>
        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>Configure bridged networking</p>

    <p>By default dhcpd based network bridge configured by libvirtd.</p>

    <p><code class="highlighter-rouge">brctl show</code></p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre> bridge name     bridge id               STP enabled     interfaces
 virbr0          8000.525500b8fe2c       yes             virbr0-nic
</pre></td></tr></tbody></table>
</div>
    </div>

    <p><code class="highlighter-rouge">virsh net-list</code></p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre>  Name                 State      Autostart     Persistent
 ----------------------------------------------------------
  default              active     yes           yes
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>All VMs (guest machine) only have network access to other VMs on the same server. A private network 192.168.122.0/24 created</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre> virsh net-dumpxml default
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>If you want your VMs avilable to other servers on your LAN, setup a a network bridge on the server that connected to the your LAN. Update your nic config file such as ifcfg-enp3s0 or em1:</p>

    <p>编辑 <code class="highlighter-rouge">/etc/sysconfig/network-scripts/enp3s0</code> ，添加 <code class="highlighter-rouge">BRIDGE=br0</code></p>

    <p>编辑 <code class="highlighter-rouge">/etc/sysconfig/network-scripts/ifcfg-br0</code> ，添加：</p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre> DEVICE="br0"
 # I am getting ip from DHCP server #
 BOOTPROTO="dhcp"
 IPV6INIT="yes"
 IPV6_AUTOCONF="yes"
 ONBOOT="yes"
 TYPE="Bridge"
 DELAY="0"
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>Restart the networking service (warning ssh command will disconnect, it is better to reboot</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre> systemctl restart NetworkManager
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>Verify it with brctl command: <code class="highlighter-rouge">brctl show</code></p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre> bridge name     bridge id               STP enabled     interfaces
 br0             8000.e0d55e4b60d1       no              enp0s31f6
 virbr0          8000.525500b8fe2c       yes             virbr0-nic
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>
    <p>======================================================</p>
  </li>
  <li>
    <p>创建VM（以创建centos 7为例）</p>
  </li>
  <li>下载iso
    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre> <span class="nb">cd</span> /var/lib/libvirt/boot/
 wget https://mirrors.nju.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso

 <span class="c"># Verify ISO images:</span>
 wget https://mirrors.nju.edu.cn/centos/7.9.2009/isos/x86_64/sha256sum.txt
 sha256sum --ignore-missing -c sha256sum.txt
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>Create CentOS 7.x VM<br />
 下例创建 CentOS 7.x VM with 2GB RAM, 2 CPU core, 1 nics and 40GB disk space
    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre> virt-install <span class="se">\</span>
 --virt-type<span class="o">=</span>kvm <span class="se">\</span>
 --name centos7 <span class="se">\</span>
 --ram 2048 <span class="se">\</span>
 --vcpus<span class="o">=</span>1 <span class="se">\</span>
 --os-variant<span class="o">=</span>centos7.0 <span class="se">\</span>
 --cdrom<span class="o">=</span>/var/lib/libvirt/boot/CentOS-7-x86_64-Minimal-2009.iso <span class="se">\</span>
 --network<span class="o">=</span><span class="nv">bridge</span><span class="o">=</span>br0,model<span class="o">=</span>virtio <span class="se">\</span>
 --graphics vnc <span class="se">\</span>
 --disk <span class="nv">path</span><span class="o">=</span>/var/lib/libvirt/images/centos7.qcow2,size<span class="o">=</span>40,bus<span class="o">=</span>virtio,format<span class="o">=</span>qcow2
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>看下 vnc 设置端口，例如，端口是 5901
    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre> virsh dumpxml centos7 | grep vnc
 &lt;graphics <span class="nb">type</span><span class="o">=</span><span class="s1">'vnc'</span> <span class="nv">port</span><span class="o">=</span><span class="s1">'5901'</span> <span class="nv">autoport</span><span class="o">=</span><span class="s1">'yes'</span> <span class="nv">listen</span><span class="o">=</span><span class="s1">'127.0.0.1'</span>&gt;
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>在工作电脑上设置一个到虚拟机的隧道
    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre> ssh vivek@server1.cyberciti.biz -L 5901:127.0.0.1:5901
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>在工作电脑上打开 vnc viewer<br />
 连接地址: localhost:5900</li>
  <li>vnc连上后，就会看到centos的安装UI界面，按照提示安装。</li>
  <li>centos安装完成后，重启完成，vnc可以连接上去，操作命令行登录，安装openssh后，使用ssh。</li>
  <li>
    <p>qcow2 磁盘文件是逐步增长的，安装centos完成后，<code class="highlighter-rouge">/var/lib/libvirt/images/centos7-1.qcow2</code>的大小约 1.7G</p>
  </li>
  <li>配置下网卡<br />
 虚拟机创建好，在 <code class="highlighter-rouge">virt-manager</code> 图形界面下，可以看到有一个虚拟网卡：
    <ul>
      <li>Network source: Bridge br0: Host devices enp0s31f6</li>
      <li>Device model: virtio</li>
    </ul>

    <p>但此时网卡默认不会启动，修改下 <code class="highlighter-rouge">/etc/sysconfig/network-scripts/</code> 中 <code class="highlighter-rouge">ONBOOT=yes</code>，<br />
 然后重启虚拟机，虚拟网卡启动后，通过host 的 bridge 进入 host 所在的 LAN。</p>
  </li>
  <li>
    <p>查询、启动、关闭虚拟机 ==============================================</p>
  </li>
  <li>列出所有虚拟机<br />
 ~~~sh<br />
 # virsh list –all<br />
  Id    Name                           State<br />
 —————————————————-
    <ul>
      <li>centos7-1                      shut off<br />
 ~~~</li>
    </ul>
  </li>
  <li>使用 <code class="highlighter-rouge">virsh start</code> 启动虚拟机
    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre> virsh start centos7-1

 virsh list --all
  Id    Name                           State
 ----------------------------------------------------
  1     centos7-1                      running
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li>使用 <code class="highlighter-rouge">virsh shutdown</code> 关闭虚拟机
    <div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre> virsh shutdown centos7-1
</pre></td></tr></tbody></table>
</div>
    </div>
  </li>
  <li></li>
  <li></li>
  <li>使用 virt-manager 安装 Windows 10 ==============================================
    <ul>
      <li><a href="https://www.spice-space.org/download.html">Spice 下载</a></li>
    </ul>
  </li>
  <li>New VM</li>
  <li>Choose how you would like to install the operating system:<br />
 勾选 Local install media(ISO image or CDROM)</li>
  <li>选择 windows 10 iso 文件</li>
  <li>勾选 Automatically detect operating system based on install media<br />
 识别出来： OS type : Windows  ,  Version : Microsoft Windows 10</li>
  <li>设置 Memory： 8192M （8G）</li>
  <li>设置CPU数目</li>
  <li>设置硬盘大小： 默认 40G</li>
  <li>设置虚拟机Name</li>
  <li>勾选 Customize configuration before install</li>
  <li>Network selection: 这里选bridge 模式： Bridge br0: Host device enp0s31f6</li>
  <li>
    <p>点击 Finish，完成创建。</p>
  </li>
  <li>继续，安装之前的配置</li>
  <li>修改虚拟硬盘的性能
    <ol>
      <li>选中 “IDE Disk 1”，修改 disk storage type 为 virtio （默认是IDE）</li>
      <li>点 Apply</li>
      <li>选中 “VirtIO Disk 1”<br />
 Performance Options<br />
     Cache mode: none<br />
     IO mode: Hypervisor default</li>
    </ol>
  </li>
  <li>设置windows iso 的 CDROM</li>
  <li>source path 点击connect，选中windows 10 的安装iso</li>
  <li>Disk bus，还是选IDE，虽然慢点，兼容性好</li>
  <li></li>
  <li>设置kvm的windows驱动 CDROM
    <ol>
      <li>Add Hardware，选择<code class="highlighter-rouge">virtio-win-0.1.229.iso</code>，Disk bus，还是选IDE，SATA的话，后面windows installer 找不到。</li>
    </ol>
  </li>
  <li>
    <p>选中“Boot Options”，设置下启动顺序</p>
  </li>
  <li>
    <p>选中 “CPU”， 勾选 “Manually set CPU topology”<br />
 Sockets: 1<br />
 Cores 和 Threads 自己看物理CPU性能判断吧。</p>
  </li>
  <li>选中 “Display Spice” ，不用改，保持默认<br />
 Type： Spice server<br />
 Listen type: Address<br />
 Address: Hypervisor default<br />
 Port: 勾选 Auto<br />
 TLS Port: 勾选 Auto</li>
  <li>
    <p>选中 “Video QXL”，不用改，保持默认<br />
 Model: QXL”</p>
  </li>
  <li>配置好后，不要x掉这个配置窗口！！ 点击窗口左上角“Begin Installation”</li>
  <li>按照提示安装，弹出“选择要安装的驱动程序”<br />
 提示：缺少计算机所需的介质驱动程序。</li>
  <li>点击“Load drivers”，浏览文件系统，在 <code class="highlighter-rouge">virtio-win-0.1.229.iso</code> 的盘下面找到驱动<br />
 硬盘驱动，<code class="highlighter-rouge">amd64/w10</code> 目录下<br />
 网卡驱动， <code class="highlighter-rouge">NetKVM</code>目录下，我没装这个驱动，也正常的。<br />
 显卡驱动， <code class="highlighter-rouge">qxldod</code>目录下，我没装这个驱动，也正常的。</li>
  <li>接下来和不同安装 Windows 10 过程一样，直到安装完成，进入windows10</li>
  <li></li>
  <li>安装 VirtIO guest tools ，会提高虚拟机Spice的性能和集成度。<br />
 包括qxl video driver and the SPICE guest agent (for copy and paste, automatic resolution switching, …)</li>
  <li>进入 <code class="highlighter-rouge">virtio-win-0.1.229.iso</code> 挂载的盘符，运行根目录下的 <code class="highlighter-rouge">wirtio-win-guest-tools</code></li>
  <li>一路next，直到装好。</li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
  <li></li>
</ol>

<h2 id="设置vm自动启动">设置VM自动启动</h2>

<p>设置自动启动</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>virsh autostart vmName
</pre></td></tr></tbody></table>
</div>
</div>

<p>关闭自动启动</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>virsh autostart VMNameHere --disable
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="关闭vm">关闭VM</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>virsh shutdown your-vm-name
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="克隆vm">克隆VM</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre>virt-clone <span class="se">\</span>
  --original ubuntu18.04 <span class="se">\</span>
  --name cloned-ubuntu <span class="se">\</span>
  --file /var/lib/libvirt/images/cu.qcow2
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="目录说明">目录说明</h2>

<p>虚拟机image默认目录： <code class="highlighter-rouge">/var/lib/libvirt/images</code><br />
系统iso光盘文件目录： <code class="highlighter-rouge">/var/lib/libvirt/isos</code><br />
虚拟机的配置xml： <code class="highlighter-rouge">/etc/libvirt/qemu</code><br />
CPU型号信息： <code class="highlighter-rouge">/usr/share/libvirt/cpu_map.xml</code></p>

<h2 id="保存vm当前状态host重启后也能恢复">保存VM当前状态，host重启后也能恢复</h2>

<ul>
  <li>refer
    <ul>
      <li><a href="https://unix.stackexchange.com/a/533755">https://unix.stackexchange.com/a/533755</a></li>
    </ul>
  </li>
</ul>

<p>保存VM当前状态： <code class="highlighter-rouge">virsh managedsave &lt;domain-name&gt;</code></p>

<p>恢复： <code class="highlighter-rouge">virsh start &lt;domain-name&gt;</code></p>

<p>保存的状态文件位置： <code class="highlighter-rouge">/var/lib/libvirt/qemu/save/&lt;domain-name&gt;.save</code></p>

<ul>
  <li>
    <p>执行 <code class="highlighter-rouge">managedsave</code> 的时候报错: <code class="highlighter-rouge">blocked by non-migratable device 0000:00:06.0/ich9_ahci</code></p>

    <div class="highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>  error: internal error: unable to execute QEMU command 'migrate': State blocked by non-migratable device '0000:00:06.0/ich9_ahci'
</pre></td></tr></tbody></table>
</div>
    </div>

    <p>据 proxmox 论坛的帖子 说： qemu 代码在 sata disk 的保存还是存在问题，不要缓存包含sata设备的VM。</p>

    <p>解决方法： 删除 SATA 类型的硬盘，同时也要删除 SATA Controller</p>

    <p>KVM 中一般使用 VirtIO 类型的硬盘，不用 SATA 也没啥关系。</p>

    <ul>
      <li>参考：
        <ul>
          <li><a href="https://forum.proxmox.com/threads/state-blocked-by-non-migratable-device-ahci.13480/">proxmox 论坛的帖子 - State blocked by non-migratable device AHCI</a></li>
          <li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1049259">Bug 1049259 - cannot migrate if SATA controller is present</a></li>
          <li></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="硬盘格式">硬盘格式</h2>

<ul>
  <li>参考
    <ul>
      <li><a href="https://docs.openstack.org/image-guide/convert-images.html">Converting between image formats</a></li>
      <li><a href=""></a></li>
      <li><a href=""></a></li>
      <li><a href=""></a></li>
    </ul>
  </li>
</ul>

<p>img 格式，转换为 qcow2</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre>qemu-img convert -f raw -O qcow2 image.img image.qcow2
</pre></td></tr></tbody></table>
</div>
</div>


      <footer class="entry-meta">
        <span class="entry-tags"></span>
        
        
      </footer>
    </div><!-- /.entry-content -->
    
    
    
  </article>
</div><!-- /#main -->
</div><!-- post container -->














<script type="text/javascript">
  // embeded-iframe
  $(window).load(function(){
    $('.embeded-iframe').each(function(){
      $(this).height($(this).contents().find('html').height());
    });
  });
</script>





<div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2023 wi. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://github.com/aron-bordin/neo-hpstr-jekyll-theme" rel="nofollow">Neo-HPSTR Theme</a>.</span>

<script src="/assets/js/main.js?20230725301728281823445"></script>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
